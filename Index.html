<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Split-Screen Parallel Browser</title>
<style>
  * { box-sizing: border-box; }
  body { 
    font-family: 'Segoe UI', Tahoma, sans-serif; 
    margin:0; 
    background:#0a0e27; 
    color:#fff; 
    overflow:hidden;
  }
  
  .login-overlay {
    position:fixed;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:rgba(10,14,39,0.98);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:1000;
  }
  .login-overlay.hidden { display:none; }
  
  .login-box {
    max-width:400px;
    width:90%;
    padding:30px;
    background:#1a1f3a;
    border-radius:12px;
    box-shadow:0 20px 60px rgba(0,0,0,0.5);
  }
  .login-box h1 { 
    margin:0 0 10px 0; 
    font-size:24px;
    text-align:center;
  }
  .login-box .subtitle {
    text-align:center;
    opacity:0.7;
    font-size:13px;
    margin-bottom:20px;
  }
  input { 
    width:100%; 
    padding:12px; 
    border-radius:8px; 
    border:1px solid #2d3748; 
    background:#0f1419;
    color:#fff;
    margin-top:8px; 
    font-size:14px;
  }
  button { 
    width:100%; 
    padding:12px; 
    border-radius:8px; 
    border:0; 
    background:#4a5de6; 
    color:#fff; 
    margin-top:12px; 
    cursor:pointer; 
    font-weight:700;
    transition: all 0.2s;
    font-size:14px;
  }
  button:hover { background:#5a6df6; transform:translateY(-1px); }
  button:disabled { background:#2d3748; cursor:not-allowed; }
  
  .status { 
    padding:10px; 
    border-radius:8px; 
    margin-top:10px; 
    display:none;
    font-size:12px;
  }
  .status.show { display:block; }
  .status.info { background:#1e3a5f; color:#60a5fa; }
  .status.success { background:#1e3d2f; color:#4ade80; }
  .status.error { background:#3d1e1e; color:#f87171; }
  
  .main-screen {
    height:100vh;
    display:flex;
    flex-direction:column;
  }
  
  .top-bar {
    background:#1a1f3a;
    padding:10px 20px;
    display:flex;
    align-items:center;
    gap:10px;
    border-bottom:2px solid #2d3748;
    flex-shrink:0;
    z-index:100;
  }
  .top-bar h1 {
    margin:0;
    font-size:18px;
    background:linear-gradient(135deg,#667eea,#764ba2);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
    white-space:nowrap;
    font-weight:900;
  }
  .url-bar {
    flex:1;
    display:flex;
    gap:8px;
  }
  .url-bar input {
    flex:1;
    margin:0;
    padding:10px;
    font-size:14px;
  }
  .url-bar button {
    width:auto;
    margin:0;
    padding:10px 20px;
    font-size:13px;
  }
  
  .mode-toggle {
    display:flex;
    gap:5px;
    background:#0f1419;
    padding:3px;
    border-radius:8px;
  }
  .mode-btn {
    padding:6px 12px;
    font-size:11px;
    border-radius:6px;
    background:transparent;
    margin:0;
    width:auto;
  }
  .mode-btn.active {
    background:#4a5de6;
  }
  
  .stats-mini {
    font-size:11px;
    color:#888;
    display:flex;
    gap:15px;
  }
  .stat-mini {
    white-space:nowrap;
  }
  .stat-mini span {
    color:#4ade80;
    font-weight:700;
  }
  
  .browser-container {
    flex:1;
    position:relative;
    overflow:hidden;
  }
  
  /* Composite Canvas Mode */
  .composite-view {
    width:100%;
    height:100%;
    position:relative;
    background:#000;
  }
  .composite-canvas {
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    max-width:100%;
    max-height:100%;
    object-fit:contain;
    cursor:crosshair;
  }
  
  /* Split Screen Mode */
  .split-view {
    width:100%;
    height:100%;
    display:grid;
    gap:2px;
    background:#2d3748;
    padding:2px;
  }
  .split-view.cols-1 { grid-template-columns: 1fr; }
  .split-view.cols-2 { grid-template-columns: 1fr 1fr; }
  .split-view.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
  
  .split-pane {
    background:#000;
    position:relative;
    overflow:hidden;
    cursor:crosshair;
  }
  .split-pane img {
    width:100%;
    height:100%;
    object-fit:contain;
    display:block;
  }
  .pane-label {
    position:absolute;
    top:5px;
    left:5px;
    background:rgba(74,93,230,0.9);
    color:#fff;
    padding:4px 8px;
    border-radius:4px;
    font-size:10px;
    font-weight:700;
    pointer-events:none;
    z-index:10;
  }
  .pane-stats {
    position:absolute;
    bottom:5px;
    left:5px;
    background:rgba(0,0,0,0.8);
    color:#4ade80;
    padding:4px 8px;
    border-radius:4px;
    font-size:10px;
    pointer-events:none;
    z-index:10;
  }
  
  .placeholder {
    width:100%;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#666;
    font-size:12px;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
</style>
</head>
<body>

<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h1>üîÄ Split-Screen Browser</h1>
    <div class="subtitle">Multiple backends rendering the same page together</div>
    
    <input id="name" placeholder="Your name" value="Alice">
    <input id="key" placeholder="Access key" type="password" value="8392017">
    
    <button id="wakeBtn" style="background:#ffd34d;color:#000">‚òï Wake All Servers</button>
    <button id="launchBtn">üöÄ Launch Split Browser</button>
    <div id="loginStatus" class="status"></div>
  </div>
</div>

<div class="main-screen" id="mainScreen" style="display:none">
  <div class="top-bar">
    <h1>üîÄ SPLIT BROWSER</h1>
    <div class="url-bar">
      <input id="globalUrl" placeholder="Navigate to..." value="https://example.com">
      <button id="globalGo">Go</button>
      <button id="globalBack">‚Üê</button>
      <button id="globalForward">‚Üí</button>
    </div>
    
    <div class="mode-toggle">
      <button class="mode-btn active" id="modeComposite">Composite</button>
      <button class="mode-btn" id="modeSplit">Split View</button>
    </div>
    
    <div class="stats-mini">
      <div class="stat-mini">FPS: <span id="fpsMini">0</span></div>
      <div class="stat-mini">Workers: <span id="workersMini">0</span></div>
    </div>
  </div>
  
  <div class="browser-container" id="browserContainer">
    <!-- Content injected based on mode -->
  </div>
</div>

<script>
// Backend server pool
const HOST_POOL = [
  { name: "R1", url: "https://render-repo-1-yto6.onrender.com" },
  { name: "R2", url: "https://render-repo-0x73.onrender.com" },
  { name: "R3", url: "https://render-repo-f64m.onrender.com" },
  { name: "R4", url: "https://render-repo-791m.onrender.com" },
];

let backends = new Map();
let userName = "";
let currentMode = 'composite'; // 'composite' or 'split'
let totalFrameCount = 0;
let lastStatsUpdate = Date.now();

// Canvas for composite mode
let compositeCanvas = null;
let compositeCtx = null;

function setStatus(msg, type) {
  const el = document.getElementById("loginStatus");
  el.innerHTML = msg;
  el.className = "status show " + (type||"");
}

function initCompositeMode() {
  const container = document.getElementById('browserContainer');
  container.innerHTML = `
    <div class="composite-view">
      <canvas id="compositeCanvas" class="composite-canvas" width="1366" height="768"></canvas>
    </div>
  `;
  
  compositeCanvas = document.getElementById('compositeCanvas');
  compositeCtx = compositeCanvas.getContext('2d');
  
  // Setup click handler
  compositeCanvas.addEventListener('click', handleCompositeClick);
  compositeCanvas.addEventListener('wheel', handleCompositeScroll, {passive: false});
}

function initSplitMode() {
  const container = document.getElementById('browserContainer');
  const cols = Math.min(backends.size, 3);
  
  container.innerHTML = `<div class="split-view cols-${cols}" id="splitGrid"></div>`;
  
  const grid = document.getElementById('splitGrid');
  let index = 0;
  
  backends.forEach((backend, url) => {
    const pane = document.createElement('div');
    pane.className = 'split-pane';
    pane.id = 'pane-' + index;
    pane.innerHTML = `
      <div class="pane-label">${backend.host.name}</div>
      <div class="pane-stats" id="stats-${index}">0 fps</div>
      <div class="placeholder">Connecting...</div>
    `;
    
    // Setup click handler for this pane
    pane.addEventListener('click', (e) => handlePaneClick(e, pane));
    pane.addEventListener('wheel', (e) => handlePaneScroll(e), {passive: false});
    
    backend.paneIndex = index;
    grid.appendChild(pane);
    index++;
  });
}

function switchMode(mode) {
  currentMode = mode;
  
  // Update button states
  document.getElementById('modeComposite').classList.toggle('active', mode === 'composite');
  document.getElementById('modeSplit').classList.toggle('active', mode === 'split');
  
  if (mode === 'composite') {
    initCompositeMode();
  } else {
    initSplitMode();
  }
}

function handleCompositeClick(e) {
  const rect = compositeCanvas.getBoundingClientRect();
  const scaleX = 1366 / rect.width;
  const scaleY = 768 / rect.height;
  const x = Math.round((e.clientX - rect.left) * scaleX);
  const y = Math.round((e.clientY - rect.top) * scaleY);
  
  sendCommand('click', { x, y });
}

function handleCompositeScroll(e) {
  sendCommand('scroll', { dy: e.deltaY });
  e.preventDefault();
}

function handlePaneClick(e, pane) {
  if (e.target.tagName !== 'IMG') return;
  
  const img = e.target;
  const rect = img.getBoundingClientRect();
  const x = Math.round((e.clientX - rect.left) * (1366 / rect.width));
  const y = Math.round((e.clientY - rect.top) * (768 / rect.height));
  
  sendCommand('click', { x, y });
}

function handlePaneScroll(e) {
  sendCommand('scroll', { dy: e.deltaY });
  e.preventDefault();
}

function updateCompositeFrame(backendUrl, imageUrl) {
  if (!compositeCtx) return;
  
  const backend = backends.get(backendUrl);
  if (!backend.image) {
    backend.image = new Image();
  }
  
  backend.image.onload = () => {
    // Draw all backend images onto the composite canvas
    // We blend them by taking the most recent frame
    compositeCtx.clearRect(0, 0, 1366, 768);
    
    // Draw the most recent frame from any backend
    let latestBackend = null;
    let latestTime = 0;
    
    backends.forEach((b, url) => {
      if (b.lastFrameTime && b.lastFrameTime > latestTime && b.image && b.image.complete) {
        latestBackend = b;
        latestTime = b.lastFrameTime;
      }
    });
    
    if (latestBackend && latestBackend.image) {
      compositeCtx.drawImage(latestBackend.image, 0, 0, 1366, 768);
    }
  };
  
  backend.image.src = imageUrl;
}

function updateSplitFrame(backendUrl, imageUrl) {
  const backend = backends.get(backendUrl);
  if (backend.paneIndex === undefined) return;
  
  const pane = document.getElementById('pane-' + backend.paneIndex);
  if (!pane) return;
  
  pane.innerHTML = `
    <div class="pane-label">${backend.host.name}</div>
    <div class="pane-stats">${backend.fps || 0} fps</div>
    <img src="${imageUrl}" alt="${backend.host.name}">
  `;
}

function updateStats() {
  const connected = Array.from(backends.values()).filter(b => b.status === 'connected');
  
  // Calculate FPS
  const now = Date.now();
  backends.forEach((backend) => {
    if (backend.frameCount > 0 && backend.lastStatsUpdate) {
      const elapsed = (now - backend.lastStatsUpdate) / 1000;
      if (elapsed > 1) {
        backend.fps = Math.round(backend.frameCount / elapsed);
        backend.frameCount = 0;
        backend.lastStatsUpdate = now;
        
        // Update split view stats
        if (currentMode === 'split' && backend.paneIndex !== undefined) {
          const statsEl = document.getElementById('stats-' + backend.paneIndex);
          if (statsEl) statsEl.textContent = backend.fps + ' fps';
        }
      }
    }
  });
  
  // Update combined FPS
  const elapsed = (now - lastStatsUpdate) / 1000;
  if (elapsed > 1) {
    const combinedFps = Math.round(totalFrameCount / elapsed);
    document.getElementById('fpsMini').textContent = combinedFps;
    totalFrameCount = 0;
    lastStatsUpdate = now;
  }
  
  document.getElementById('workersMini').textContent = connected.length;
}

function sendCommand(action, data) {
  backends.forEach((backend) => {
    if (backend.status === 'connected' && backend.ws.readyState === WebSocket.OPEN) {
      backend.ws.send(JSON.stringify({type:'control', action, ...data}));
    }
  });
}

async function connectBackend(host, index) {
  const wsUrl = host.url.replace(/^http/, 'ws') + '/ws';
  
  try {
    const ws = new WebSocket(wsUrl);
    ws.binaryType = 'arraybuffer';
    
    const backendData = {
      ws: ws,
      host: host,
      status: 'connecting',
      latency: null,
      frameCount: 0,
      lastFrameTime: null,
      lastStatsUpdate: Date.now(),
      fps: 0,
      startTime: Date.now(),
      paneIndex: index,
      image: null
    };
    
    backends.set(host.url, backendData);
    
    ws.onopen = () => {
      console.log(`‚úÖ Connected to ${host.name}`);
      backendData.status = 'authenticating';
      ws.send(JSON.stringify({type:'control', action:'create', userName: userName}));
    };
    
    ws.onmessage = (e) => {
      if (typeof e.data === 'string') {
        try {
          const j = JSON.parse(e.data);
          if (j.type === 'info' && j.action === 'created') {
            backendData.status = 'connected';
            backendData.latency = Date.now() - backendData.startTime;
            console.log(`‚úÖ ${host.name} ready (${backendData.latency}ms)`);
            
            ws.send(JSON.stringify({type:'control', action:'startStream'}));
            updateStats();
          }
          if (j.type === 'error') {
            console.error(`Error from ${host.name}:`, j.message);
            backendData.status = 'error';
          }
        } catch (err) {}
        return;
      }
      
      // Handle frame
      const blob = new Blob([e.data], { type: 'image/jpeg' });
      const url = URL.createObjectURL(blob);
      
      backendData.frameCount++;
      backendData.lastFrameTime = Date.now();
      totalFrameCount++;
      
      if (!backendData.lastStatsUpdate) {
        backendData.lastStatsUpdate = Date.now();
      }
      
      // Update display based on current mode
      if (currentMode === 'composite') {
        updateCompositeFrame(host.url, url);
      } else {
        updateSplitFrame(host.url, url);
      }
      
      // Cleanup old frame
      if (backendData.lastFrameUrl) {
        setTimeout(() => URL.revokeObjectURL(backendData.lastFrameUrl), 1000);
      }
      backendData.lastFrameUrl = url;
      
      updateStats();
    };
    
    ws.onerror = () => {
      console.error(`Connection error: ${host.name}`);
      backendData.status = 'error';
      updateStats();
    };
    
    ws.onclose = () => {
      console.log(`Disconnected: ${host.name}`);
      backendData.status = 'disconnected';
      updateStats();
      
      setTimeout(() => {
        console.log(`Reconnecting to ${host.name}...`);
        connectBackend(host, index);
      }, 5000);
    };
    
  } catch (err) {
    console.error(`Failed to connect to ${host.name}:`, err);
  }
}

async function validateAndLaunch() {
  const name = document.getElementById('name').value.trim();
  const key = document.getElementById('key').value.trim();
  
  if (!name || !key) {
    setStatus("‚ùå Enter name and key", "error");
    return;
  }
  
  userName = name;
  setStatus("üîç Validating credentials...", "info");
  
  let validated = false;
  for (const host of HOST_POOL) {
    try {
      const r = await fetch(host.url + "/validate?name=" + encodeURIComponent(name) + "&key=" + encodeURIComponent(key));
      const j = await r.json();
      if (j.valid) {
        validated = true;
        break;
      }
    } catch (e) {
      continue;
    }
  }
  
  if (!validated) {
    setStatus("‚ùå Invalid credentials", "error");
    return;
  }
  
  document.getElementById('loginOverlay').classList.add('hidden');
  document.getElementById('mainScreen').style.display = 'flex';
  
  // Initialize composite mode
  initCompositeMode();
  
  // Connect to all backends
  HOST_POOL.forEach((host, index) => {
    connectBackend(host, index);
  });
  
  updateStats();
}

// Wake servers
document.getElementById('wakeBtn').addEventListener('click', async () => {
  setStatus("‚òï Waking all servers...", "info");
  
  let online = 0;
  const checks = HOST_POOL.map(async (host) => {
    try {
      const r = await fetch(host.url + "/health", { cache: 'no-store' });
      const j = await r.json();
      if (j.status === "ok") {
        online++;
        return `‚úÖ ${host.name}: Online`;
      }
    } catch (e) {
      return `‚ùå ${host.name}: Offline`;
    }
  });
  
  const results = await Promise.all(checks);
  setStatus(results.join('<br>') + `<br><br><strong>Online: ${online}/${HOST_POOL.length}</strong>`, 
    online === HOST_POOL.length ? "success" : "info");
});

// Event listeners
document.getElementById('launchBtn').addEventListener('click', validateAndLaunch);

document.getElementById('globalGo').addEventListener('click', () => {
  let url = document.getElementById('globalUrl').value.trim();
  if (url) {
    if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
    sendCommand('navigate', { url });
  }
});

document.getElementById('globalBack').addEventListener('click', () => {
  sendCommand('back', {});
});

document.getElementById('globalForward').addEventListener('click', () => {
  sendCommand('forward', {});
});

document.getElementById('modeComposite').addEventListener('click', () => {
  switchMode('composite');
});

document.getElementById('modeSplit').addEventListener('click', () => {
  switchMode('split');
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
    e.preventDefault();
    document.getElementById('globalUrl').focus();
    document.getElementById('globalUrl').select();
  }
});

// Stats update loop
setInterval(updateStats, 1000);
</script>
</body>
</html>