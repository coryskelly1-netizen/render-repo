<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Remote Browser Proxy</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, sans-serif; margin:0; background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px; }
  .card { background:#fff;color:#222;padding:28px;border-radius:12px;max-width:420px;width:100%;box-shadow:0 18px 50px rgba(0,0,0,.25); }
  h2{margin:0 0 12px 0;text-align:center}
  input{width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;margin-top:10px}
  button{width:100%;padding:12px;border-radius:8px;border:0;background:#4a5de6;color:#fff;margin-top:12px;cursor:pointer;font-weight:700}
  .wake{background:#ffd34d;color:#000}
  .status{margin-top:12px;padding:10px;border-radius:8px;display:none}
  .status.show{display:block}
  .info{font-size:12px;color:#666;margin-top:12px;background:#f5f5f5;padding:10px;border-radius:8px;color:#333}
</style>
</head>
<body>
<div class="card">
  <h2>üåê Remote Browser</h2>
  <input id="name" placeholder="Your name">
  <input id="key" placeholder="Access key" type="password">
  <button id="wakeBtn" class="wake">‚òï Wake Server</button>
  <button id="loginBtn">üöÄ Login & Launch</button>
  <div id="status" class="status"></div>
  <div class="info">Streams a remote Chromium session. Use responsibly.</div>
</div>

<script>
const API = "https://render-repo-1-yto6.onrender.com";

function setStatus(msg, type) {
  const el = document.getElementById("status");
  el.innerHTML = msg;
  el.className = "status show " + (type||"");
}

document.getElementById("wakeBtn").addEventListener("click", async () => {
  setStatus("Waking server...", "info");
  try {
    const r = await fetch(API + "/health");
    const j = await r.json();
    if (j.status === "ok") setStatus("Server ready", "success");
    else setStatus("Server responded but not OK", "error");
  } catch (e) {
    setStatus("Server unreachable: " + e.message, "error");
  }
});

document.getElementById("loginBtn").addEventListener("click", async () => {
  const name = document.getElementById("name").value.trim();
  const key = document.getElementById("key").value.trim();
  if (!name || !key) { setStatus("Enter name and key", "error"); return; }

  setStatus("Validating...", "info");
  try {
    const r = await fetch(API + "/validate?name=" + encodeURIComponent(name) + "&key=" + encodeURIComponent(key));
    const j = await r.json();
    if (!j.valid) { setStatus("Invalid credentials", "error"); return; }

    const wsURL = API.replace(/^http/, "ws") + "/ws";

    const popup = window.open("", "_blank", "width=1366,height=768");
    if (!popup) { setStatus("Popup blocked ‚Äî allow popups", "error"); return; }

    popup.document.write(\`
      <!doctype html>
      <html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
      <title>Remote Browser</title>
      <style>
        body{margin:0;background:#000;color:#fff;font-family:Segoe UI,Arial;overflow:hidden} 
        .bar{background:#111;padding:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap} 
        .url{flex:1;min-width:200px;padding:8px;border-radius:999px;border:1px solid #333;background:#0d0d0d;color:#fff} 
        button{padding:8px 16px;border-radius:999px;border:1px solid #333;background:#222;color:#fff;cursor:pointer}
        button:hover{background:#333}
        .view{height:calc(100vh - 48px);display:flex;align-items:center;justify-content:center;position:relative} 
        img{max-width:100%;max-height:100%;object-fit:contain;cursor:crosshair}
        .msg{color:#ddd;text-align:center}
        .controls{display:flex;gap:4px}
      </style>
      </head><body>
      <div class="bar">
        <input id="url" class="url" placeholder="example.com">
        <div class="controls">
          <button id="go">Go</button>
          <button id="back">‚Üê</button>
          <button id="forward">‚Üí</button>
        </div>
      </div>
      <div id="view" class="view">Connecting...</div>
      <script>
        const WS = "\${wsURL}";
        let ws = null;
        let focused = false;
        
        function showMsg(t){ document.getElementById('view').innerHTML = '<div class="msg">'+t+'</div>' }
        
        function connect() {
          ws = new WebSocket(WS); 
          ws.binaryType = 'arraybuffer';
          
          ws.onopen = ()=>{ 
            showMsg('Connected ‚Äî creating session...'); 
            ws.send(JSON.stringify({type:'control', action:'create', userName:'\${name}'})); 
          };
          
          ws.onmessage = (e)=> {
            if (typeof e.data === 'string') {
              try { 
                const j = JSON.parse(e.data); 
                if (j.type==='info' && j.action==='created') { 
                  ws.send(JSON.stringify({type:'control', action:'startStream'})); 
                  showMsg('Streaming...'); 
                } 
                if (j.type==='error') { 
                  showMsg('Server error: '+j.message); 
                } 
              } catch {}
              return;
            }
            
            const blob = new Blob([e.data], { type: 'image/jpeg' });
            const url = URL.createObjectURL(blob);
            document.getElementById('view').innerHTML = '<img id="frame" src="'+url+'" tabindex="0">';
            setTimeout(()=>URL.revokeObjectURL(url), 10000);
            
            const img = document.getElementById('frame');
            
            // Click handler
            img.onclick = (ev)=> {
              const r = img.getBoundingClientRect();
              const x = Math.round((ev.clientX - r.left) * (1366 / r.width));
              const y = Math.round((ev.clientY - r.top) * (768 / r.height));
              if (ws && ws.readyState===WebSocket.OPEN) {
                ws.send(JSON.stringify({type:'control', action:'click', x, y}));
              }
              img.focus();
            };
            
            // Keyboard handler - NEW!
            img.addEventListener('keydown', (ev)=> {
              if (ws && ws.readyState===WebSocket.OPEN) {
                // Send the typed character
                if (ev.key.length === 1) {
                  ws.send(JSON.stringify({type:'control', action:'type', text: ev.key}));
                  ev.preventDefault();
                }
                // Handle special keys
                else if (ev.key === 'Enter') {
                  ws.send(JSON.stringify({type:'control', action:'type', text: '\\n'}));
                  ev.preventDefault();
                }
                else if (ev.key === 'Backspace') {
                  ws.send(JSON.stringify({type:'control', action:'type', text: '\\b'}));
                  ev.preventDefault();
                }
                else if (ev.key === 'Tab') {
                  ws.send(JSON.stringify({type:'control', action:'type', text: '\\t'}));
                  ev.preventDefault();
                }
              }
            });
            
            // Scroll handler - NEW!
            img.addEventListener('wheel', (ev)=> {
              if (ws && ws.readyState===WebSocket.OPEN) {
                ws.send(JSON.stringify({type:'control', action:'scroll', dy: ev.deltaY}));
                ev.preventDefault();
              }
            }, {passive: false});
            
            // Auto-focus for keyboard input
            setTimeout(()=>img.focus(), 100);
          };
          
          ws.onerror = (e) => showMsg('Connection error');
          ws.onclose = ()=> showMsg('Disconnected');
        }
        
        connect();
        
        // Navigation controls
        document.getElementById('go').onclick = ()=> {
          const u = document.getElementById('url').value.trim();
          if (!u) return;
          if (ws && ws.readyState===WebSocket.OPEN) {
            ws.send(JSON.stringify({type:'control', action:'navigate', url: u}));
          }
        };
        
        document.getElementById('url').addEventListener('keydown', (ev)=> {
          if (ev.key === 'Enter') {
            document.getElementById('go').click();
          }
        });
        
        document.getElementById('back').onclick = ()=> {
          if (ws && ws.readyState===WebSocket.OPEN) {
            ws.send(JSON.stringify({type:'control', action:'back'}));
          }
        };
        
        document.getElementById('forward').onclick = ()=> {
          if (ws && ws.readyState===WebSocket.OPEN) {
            ws.send(JSON.stringify({type:'control', action:'forward'}));
          }
        };
      <\/script>
      </body></html>
    \`);
    popup.document.close();
    setStatus("Popup opened", "success");
  } catch (e) {
    setStatus("Connection failed: " + e.message, "error");
  }
});
</script>
</body>
</html>