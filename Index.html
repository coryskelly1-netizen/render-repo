<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Render Proxy Login</title>
<style>
  body { font-family:Segoe UI,Tahoma; margin:0; background:#4a5de6; color:#fff;
         display:flex; align-items:center; justify-content:center; height:100vh; }
  .card { background:#fff; color:#222; padding:28px; width:320px; border-radius:12px;
          box-shadow:0 8px 30px rgba(0,0,0,.25); }
  input { width:100%; padding:10px; margin-top:8px; border-radius:8px; border:1px solid #ccc; }
  button { width:100%; margin-top:12px; padding:12px; border-radius:8px;
           border:0; cursor:pointer; background:#4a5de6; color:#fff; font-weight:700; }
  .sec { background:#ffd34d; color:#000; }
  .status { margin-top:10px; padding:10px; border-radius:6px; display:none; }
  .ok { display:block; background:#e6ffe8; color:#056632; }
  .bad { display:block; background:#ffe8e8; color:#7b1f1f; }
</style>
</head>
<body>

<div class="card">
  <h2>Render Proxy</h2>

  <input id="name" placeholder="Your Name">
  <input id="key" placeholder="Your Key">

  <button class="sec" id="wake">☕ Wake Server</button>
  <button id="login">Login & Launch</button>

  <div id="status" class="status"></div>
</div>

<!-- Popup Template -->
<script type="text/template" id="tpl">
<!doctype html><html><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Remote Browser</title>
<style>
 body { margin:0; background:#000; color:#fff; font-family:Segoe UI,Tahoma; }
 .bar { background:#111; padding:8px; display:flex; gap:8px; }
 .btn { background:#222; border:1px solid #333; color:#fff; padding:8px; border-radius:6px; cursor:pointer; }
 .main { height:calc(100vh - 48px); display:flex; align-items:center; justify-content:center; }
 img { max-width:100%; max-height:100%; object-fit:contain; user-select:none; }
 .url { flex:1; padding:8px; background:#0d0d0d; border:1px solid #333; color:#fff; border-radius:999px; }
</style>
</head>
<body>

<div class="bar">
  <button id="back" class="btn">◀</button>
  <button id="forward" class="btn">▶</button>
  <input id="url" class="url" placeholder="example.com">
  <button id="go" class="btn">Go</button>
</div>

<div id="view" class="main">Waiting for video…</div>

<script>
(function(){

 const ws = new WebSocket("{{WS}}");
 ws.binaryType = "arraybuffer";

 ws.onopen = () => {
   ws.send(JSON.stringify({ type:"control", action:"create", userName:"{{USER}}" }));
 };

 ws.onmessage = (e) => {
   // Control messages
   if (typeof e.data === "string") {
     let j = JSON.parse(e.data);
     if (j.action === "created") {
       ws.send(JSON.stringify({ type:"control", action:"startStream" }));
     }
     return;
   }

   // Binary JPEG frame
   const blob = new Blob([e.data], { type:"image/jpeg" });
   const url = URL.createObjectURL(blob);

   const v = document.getElementById("view");
   v.innerHTML = "<img id='frame' src='"+url+"'>";

   setTimeout(()=>URL.revokeObjectURL(url), 8000);

   const img = document.getElementById("frame");
   img.onclick = (ev)=>{
     const r = img.getBoundingClientRect();
     const x = Math.round((ev.clientX - r.left) * (1366 / r.width));
     const y = Math.round((ev.clientY - r.top) * (768 / r.height));
     ws.send(JSON.stringify({ type:"control", action:"click", x, y }));
   };
 };

 // Navigation
 document.getElementById("go").onclick = ()=>{
   let u = document.getElementById("url").value.trim();
   if (!u) return;
   if (!/^https?:\/\//i.test(u)) u = "https://" + u;
   ws.send(JSON.stringify({ type:"control", action:"navigate", url:u }));
 };

 document.getElementById("back").onclick =
   ()=> ws.send(JSON.stringify({ type:"control", action:"back" }));

 document.getElementById("forward").onclick =
   ()=> ws.send(JSON.stringify({ type:"control", action:"forward" }));

 // Scroll
 document.getElementById("view").addEventListener("wheel",(ev)=>{
   ev.preventDefault();
   ws.send(JSON.stringify({
     type:"control",
     action:"scroll",
     dx:0,
     dy:Math.round(ev.deltaY)
   }));
 }, { passive:false });

 // Keyboard typing
 document.addEventListener("keydown",(e)=>{
   if (document.activeElement.id === "url") return;
   ws.send(JSON.stringify({
     type:"control",
     action:"type",
     text:e.key
   }));
 });

})();
</script>

</body></html>
</script>

<script>
const API = "https://render-repo-osyl.onrender.com";

function setStatus(msg, ok) {
  const el = document.getElementById("status");
  el.textContent = msg;
  el.className = "status " + (ok ? "ok" : "bad");
}

document.getElementById("wake").onclick = async () => {
  setStatus("Waking...", false);
  try {
    const r = await fetch(API + "/health");
    const j = await r.json();
    setStatus(j.status === "ok" ? "Server Ready" : "Not OK", j.status === "ok");
  } catch {
    setStatus("Unreachable", false);
  }
};

document.getElementById("login").onclick = async () => {
  const name = document.getElementById("name").value.trim();
  const key = document.getElementById("key").value.trim();

  if (!name || !key) return setStatus("Missing fields", false);

  const r = await fetch(API + "/validate?name=" + name + "&key=" + key);
  const j = await r.json();

  if (!j.valid) return setStatus("Invalid login", false);

  const wsURL = API.replace("https://", "wss://") + "/ws";

  const tpl = document.getElementById("tpl").innerHTML
    .replace(/{{USER}}/g, name)
    .replace(/{{WS}}/g, wsURL);

  const w = window.open("", "_blank");
  if (!w) return alert("Popup blocked");
  w.document.write(tpl);
  w.document.close();

  setStatus("Proxy Launched!", true);
};
</script>

</body>
</html>
