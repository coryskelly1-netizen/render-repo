<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Remote Browser Proxy</title>
<style>
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
  }
  
  .card { 
    background: #fff;
    color: #333;
    padding: 35px;
    max-width: 380px;
    width: 100%;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,.3);
  }
  
  h2 {
    margin: 0 0 20px 0;
    font-size: 24px;
    text-align: center;
  }
  
  input { 
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border-radius: 8px;
    border: 2px solid #e0e0e0;
    font-size: 14px;
    transition: border-color 0.3s;
    box-sizing: border-box;
  }
  
  input:focus {
    outline: none;
    border-color: #667eea;
  }
  
  button { 
    width: 100%;
    margin-top: 12px;
    padding: 14px;
    border-radius: 8px;
    border: 0;
    cursor: pointer;
    background: #667eea;
    color: #fff;
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s;
  }
  
  button:hover {
    background: #5568d3;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }
  
  button:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
  }
  
  .wake-btn { 
    background: #ffd34d;
    color: #000;
  }
  
  .wake-btn:hover {
    background: #ffc61a;
  }
  
  .status { 
    margin-top: 15px;
    padding: 12px;
    border-radius: 8px;
    display: none;
    font-size: 14px;
    text-align: center;
  }
  
  .status.show { display: block; }
  
  .status.success { 
    background: #e6ffe8;
    color: #056632;
    border: 1px solid #b3f0b8;
  }
  
  .status.error { 
    background: #ffe8e8;
    color: #7b1f1f;
    border: 1px solid #ffb3b3;
  }
  
  .status.info {
    background: #e8f4ff;
    color: #0d4a7a;
    border: 1px solid #b3d9ff;
  }
  
  .info-text {
    margin-top: 20px;
    padding: 15px;
    background: #f5f5f5;
    border-radius: 8px;
    font-size: 12px;
    color: #666;
  }
  
  .spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid rgba(0,0,0,.1);
    border-left-color: currentColor;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 8px;
    vertical-align: middle;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<div class="card">
  <h2>üåê Remote Browser</h2>

  <input id="name" placeholder="Your Name" autocomplete="username">
  <input id="key" type="password" placeholder="Your Key" autocomplete="current-password">

  <button class="wake-btn" id="wake">‚òï Wake Server</button>
  <button id="login">üöÄ Login & Launch</button>

  <div id="status" class="status"></div>
  
  <div class="info-text">
    <strong>Educational Project</strong><br>
    This proxy streams a remote browser via WebSocket. Use responsibly and in accordance with your institution's policies.
  </div>
</div>

<script>
// Your Render.com deployment URL
const API = "https://render-repo-osyl.onrender.com";

function setStatus(msg, type = 'info') {
  const el = document.getElementById("status");
  el.innerHTML = msg;
  el.className = "status show " + type;
}

function clearStatus() {
  const el = document.getElementById("status");
  el.className = "status";
}

// Wake button handler
document.getElementById("wake").onclick = async () => {
  const btn = document.getElementById("wake");
  btn.disabled = true;
  setStatus('<span class="spinner"></span>Waking server...', 'info');
  
  try {
    const r = await fetch(API + "/health", { 
      method: 'GET',
      signal: AbortSignal.timeout(15000) // 15s timeout
    });
    
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    
    const j = await r.json();
    
    if (j.status === "ok") {
      setStatus('‚úÖ Server is ready!', 'success');
    } else {
      setStatus('‚ö†Ô∏è Server responded but status is not OK', 'error');
    }
  } catch (error) {
    console.error('Wake error:', error);
    setStatus(`‚ùå Server unreachable: ${error.message}`, 'error');
  } finally {
    btn.disabled = false;
  }
};

// Login button handler
document.getElementById("login").onclick = async () => {
  const name = document.getElementById("name").value.trim();
  const key = document.getElementById("key").value.trim();
  const btn = document.getElementById("login");

  if (!name || !key) {
    setStatus('‚ùå Please enter both name and key', 'error');
    return;
  }

  btn.disabled = true;
  setStatus('<span class="spinner"></span>Validating credentials...', 'info');

  try {
    const r = await fetch(
      `${API}/validate?name=${encodeURIComponent(name)}&key=${encodeURIComponent(key)}`,
      { signal: AbortSignal.timeout(10000) }
    );
    
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    
    const j = await r.json();

    if (!j.valid) {
      setStatus('‚ùå Invalid credentials', 'error');
      btn.disabled = false;
      return;
    }

    // Generate popup content
    const wsURL = API.replace("https://", "wss://") + "/ws";
    const popupHTML = generatePopupHTML(name, wsURL);

    // Open popup
    const w = window.open("", "_blank", "width=1400,height=900");
    
    if (!w) {
      setStatus('‚ùå Popup blocked! Please allow popups for this site.', 'error');
      btn.disabled = false;
      return;
    }

    w.document.write(popupHTML);
    w.document.close();

    setStatus('‚úÖ Browser launched successfully!', 'success');
    
    // Re-enable button after 3 seconds
    setTimeout(() => {
      btn.disabled = false;
    }, 3000);

  } catch (error) {
    console.error('Login error:', error);
    setStatus(`‚ùå Connection failed: ${error.message}`, 'error');
    btn.disabled = false;
  }
};

// Enter key support
document.getElementById("key").addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    document.getElementById("login").click();
  }
});

function generatePopupHTML(userName, wsURL) {
  return `<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Remote Browser - ${userName}</title>
<style>
 body { 
   margin: 0;
   background: #0a0a0a;
   color: #fff;
   font-family: 'Segoe UI', Tahoma, sans-serif;
   overflow: hidden;
 }
 
 .toolbar { 
   background: linear-gradient(180deg, #1a1a1a 0%, #111 100%);
   padding: 10px;
   display: flex;
   gap: 8px;
   align-items: center;
   border-bottom: 1px solid #333;
   box-shadow: 0 2px 10px rgba(0,0,0,0.5);
 }
 
 .btn { 
   background: #2a2a2a;
   border: 1px solid #444;
   color: #fff;
   padding: 8px 12px;
   border-radius: 6px;
   cursor: pointer;
   font-size: 14px;
   transition: all 0.2s;
   min-width: 40px;
 }
 
 .btn:hover {
   background: #3a3a3a;
   border-color: #555;
 }
 
 .btn:active {
   transform: scale(0.95);
 }
 
 .url-bar { 
   flex: 1;
   padding: 8px 16px;
   background: #1a1a1a;
   border: 1px solid #444;
   color: #fff;
   border-radius: 20px;
   font-size: 14px;
   outline: none;
   transition: all 0.2s;
 }
 
 .url-bar:focus {
   border-color: #667eea;
   background: #222;
 }
 
 .view-container { 
   height: calc(100vh - 60px);
   display: flex;
   align-items: center;
   justify-content: center;
   background: #000;
   position: relative;
 }
 
 .frame-img { 
   max-width: 100%;
   max-height: 100%;
   object-fit: contain;
   user-select: none;
   cursor: pointer;
   box-shadow: 0 0 30px rgba(0,0,0,0.8);
 }
 
 .status-overlay {
   position: absolute;
   top: 50%;
   left: 50%;
   transform: translate(-50%, -50%);
   background: rgba(0,0,0,0.9);
   padding: 30px;
   border-radius: 12px;
   text-align: center;
   min-width: 250px;
 }
 
 .spinner {
   border: 3px solid rgba(255,255,255,.1);
   border-left-color: #667eea;
   border-radius: 50%;
   width: 40px;
   height: 40px;
   animation: spin 1s linear infinite;
   margin: 0 auto 15px;
 }
 
 @keyframes spin {
   to { transform: rotate(360deg); }
 }
 
 .user-badge {
   background: #667eea;
   color: #fff;
   padding: 6px 12px;
   border-radius: 12px;
   font-size: 12px;
   font-weight: 600;
 }
 
 .error-msg {
   color: #ff6b6b;
   padding: 10px;
   background: rgba(255,107,107,0.1);
   border-radius: 6px;
   margin-top: 10px;
 }
</style>
</head>
<body>

<div class="toolbar">
  <button id="back" class="btn" title="Back">‚óÄ</button>
  <button id="forward" class="btn" title="Forward">‚ñ∂</button>
  <button id="refresh" class="btn" title="Refresh">‚Üª</button>
  <input id="url" class="url-bar" placeholder="Enter URL (e.g., example.com)">
  <button id="go" class="btn" style="background:#667eea">Go</button>
  <span class="user-badge">${userName}</span>
</div>

<div id="view" class="view-container">
  <div class="status-overlay">
    <div class="spinner"></div>
    <div>Connecting to server...</div>
    <div id="error" class="error-msg" style="display:none"></div>
  </div>
</div>

<script>
(function() {
  let ws = null;
  let reconnectAttempts = 0;
  const MAX_RECONNECT = 3;
  
  function showError(msg) {
    const err = document.getElementById("error");
    err.textContent = msg;
    err.style.display = "block";
  }
  
  function connect() {
    ws = new WebSocket("${wsURL}");
    ws.binaryType = "arraybuffer";

    ws.onopen = () => {
      console.log("‚úÖ WebSocket connected");
      reconnectAttempts = 0;
      ws.send(JSON.stringify({ 
        type: "control",
        action: "create",
        userName: "${userName}"
      }));
    };

    ws.onmessage = (e) => {
      // Control messages (JSON)
      if (typeof e.data === "string") {
        try {
          const j = JSON.parse(e.data);
          
          if (j.type === "info" && j.action === "created") {
            ws.send(JSON.stringify({ 
              type: "control",
              action: "startStream"
            }));
          }
          
          if (j.type === "error") {
            showError("Server error: " + j.message);
          }
        } catch (err) {
          console.error("Error parsing message:", err);
        }
        return;
      }

      // Binary JPEG frame
      const blob = new Blob([e.data], { type: "image/jpeg" });
      const url = URL.createObjectURL(blob);

      const view = document.getElementById("view");
      view.innerHTML = '<img id="frame" class="frame-img" src="' + url + '">';

      setTimeout(() => URL.revokeObjectURL(url), 10000);

      // Click handler
      const img = document.getElementById("frame");
      img.onclick = (ev) => {
        const r = img.getBoundingClientRect();
        const x = Math.round((ev.clientX - r.left) * (1366 / r.width));
        const y = Math.round((ev.clientY - r.top) * (768 / r.height));
        
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ 
            type: "control",
            action: "click",
            x, y
          }));
        }
      };
    };

    ws.onerror = (error) => {
      console.error("‚ùå WebSocket error:", error);
      showError("Connection error occurred");
    };

    ws.onclose = () => {
      console.log("üîå WebSocket closed");
      
      if (reconnectAttempts < MAX_RECONNECT) {
        reconnectAttempts++;
        showError(\`Connection lost. Reconnecting... (\${reconnectAttempts}/\${MAX_RECONNECT})\`);
        setTimeout(connect, 2000 * reconnectAttempts);
      } else {
        showError("Failed to connect after multiple attempts. Please refresh.");
      }
    };
  }

  // Initial connection
  connect();

  // Navigation handlers
  document.getElementById("go").onclick = () => {
    let u = document.getElementById("url").value.trim();
    if (!u) return;
    if (!/^https?:\\/\\//i.test(u)) u = "https://" + u;
    
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ 
        type: "control",
        action: "navigate",
        url: u
      }));
    }
  };

  document.getElementById("url").addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      document.getElementById("go").click();
    }
  });

  document.getElementById("back").onclick = () => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: "control", action: "back" }));
    }
  };

  document.getElementById("forward").onclick = () => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: "control", action: "forward" }));
    }
  };

  document.getElementById("refresh").onclick = () => {
    const u = document.getElementById("url").value.trim();
    if (u && ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ 
        type: "control",
        action: "navigate",
        url: u
      }));
    }
  };

  // Scroll handling
  document.getElementById("view").addEventListener("wheel", (ev) => {
    ev.preventDefault();
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({
        type: "control",
        action: "scroll",
        dx: 0,
        dy: Math.round(ev.deltaY)
      }));
    }
  }, { passive: false });

  // Keyboard typing
  document.addEventListener("keydown", (e) => {
    if (document.activeElement.id === "url") return;
    
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({
        type: "control",
        action: "type",
        text: e.key
      }));
    }
  });

  // Cleanup on window close
  window.addEventListener("beforeunload", () => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: "control", action: "close" }));
      ws.close();
    }
  });
})();
</script>

</body>
</html>`;
}
</script>

</body>
</html>