<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Remote Browser Proxy</title>
<style>
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
  }
  
  .card { 
    background: #fff;
    color: #333;
    padding: 35px;
    max-width: 380px;
    width: 100%;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,.3);
  }
  
  h2 {
    margin: 0 0 20px 0;
    font-size: 24px;
    text-align: center;
  }
  
  input { 
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border-radius: 8px;
    border: 2px solid #e0e0e0;
    font-size: 14px;
    transition: border-color 0.3s;
    box-sizing: border-box;
  }
  
  input:focus {
    outline: none;
    border-color: #667eea;
  }
  
  button { 
    width: 100%;
    margin-top: 12px;
    padding: 14px;
    border-radius: 8px;
    border: 0;
    cursor: pointer;
    background: #667eea;
    color: #fff;
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s;
  }
  
  button:hover {
    background: #5568d3;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }
  
  button:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
  }
  
  .wake-btn { 
    background: #ffd34d;
    color: #000;
  }
  
  .wake-btn:hover {
    background: #ffc61a;
  }
  
  .status { 
    margin-top: 15px;
    padding: 12px;
    border-radius: 8px;
    display: none;
    font-size: 14px;
    text-align: center;
  }
  
  .status.show { display: block; }
  
  .status.success { 
    background: #e6ffe8;
    color: #056632;
    border: 1px solid #b3f0b8;
  }
  
  .status.error { 
    background: #ffe8e8;
    color: #7b1f1f;
    border: 1px solid #ffb3b3;
  }
  
  .status.info {
    background: #e8f4ff;
    color: #0d4a7a;
    border: 1px solid #b3d9ff;
  }
  
  .info-text {
    margin-top: 20px;
    padding: 15px;
    background: #f5f5f5;
    border-radius: 8px;
    font-size: 12px;
    color: #666;
  }
  
  .spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid rgba(0,0,0,.1);
    border-left-color: currentColor;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 8px;
    vertical-align: middle;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<div class="card">
  <h2>üåê Remote Browser</h2>

  <input id="name" placeholder="Your Name" autocomplete="username">
  <input id="key" type="password" placeholder="Your Key" autocomplete="current-password">

  <button class="wake-btn" id="wake">‚òï Wake Server</button>
  <button id="login">üöÄ Login & Launch</button>

  <div id="status" class="status"></div>
  
  <div class="info-text">
    <strong>Educational Project</strong><br>
    This proxy streams a remote browser via WebSocket. Use responsibly and in accordance with your institution's policies.
  </div>
</div>

<script>
// Your Render.com deployment URL
const API = "https://render-repo-osyl.onrender.com";

function setStatus(msg, type) {
  const el = document.getElementById("status");
  el.innerHTML = msg;
  el.className = "status show " + type;
}

function clearStatus() {
  const el = document.getElementById("status");
  el.className = "status";
}

// Wake button handler
document.getElementById("wake").addEventListener("click", async function() {
  const btn = document.getElementById("wake");
  btn.disabled = true;
  setStatus('<span class="spinner"></span>Waking server...', 'info');
  
  try {
    const r = await fetch(API + "/health", { 
      method: 'GET'
    });
    
    if (!r.ok) throw new Error("HTTP " + r.status);
    
    const j = await r.json();
    
    if (j.status === "ok") {
      setStatus('‚úÖ Server is ready!', 'success');
    } else {
      setStatus('‚ö†Ô∏è Server responded but status is not OK', 'error');
    }
  } catch (error) {
    console.error('Wake error:', error);
    setStatus("‚ùå Server unreachable: " + error.message, 'error');
  } finally {
    btn.disabled = false;
  }
});

// Login button handler
document.getElementById("login").addEventListener("click", async function() {
  const name = document.getElementById("name").value.trim();
  const key = document.getElementById("key").value.trim();
  const btn = document.getElementById("login");

  if (!name || !key) {
    setStatus('‚ùå Please enter both name and key', 'error');
    return;
  }

  btn.disabled = true;
  setStatus('<span class="spinner"></span>Validating credentials...', 'info');

  try {
    const r = await fetch(
      API + "/validate?name=" + encodeURIComponent(name) + "&key=" + encodeURIComponent(key)
    );
    
    if (!r.ok) throw new Error("HTTP " + r.status);
    
    const j = await r.json();

    if (!j.valid) {
      setStatus('‚ùå Invalid credentials', 'error');
      btn.disabled = false;
      return;
    }

    // Generate popup content
    const wsURL = API.replace("https://", "wss://") + "/ws";
    const popupHTML = generatePopupHTML(name, wsURL);

    // Open popup
    const w = window.open("", "_blank", "width=1400,height=900");
    
    if (!w) {
      setStatus('‚ùå Popup blocked! Please allow popups for this site.', 'error');
      btn.disabled = false;
      return;
    }

    w.document.write(popupHTML);
    w.document.close();

    setStatus('‚úÖ Browser launched successfully!', 'success');
    
    // Re-enable button after 3 seconds
    setTimeout(function() {
      btn.disabled = false;
    }, 3000);

  } catch (error) {
    console.error('Login error:', error);
    setStatus("‚ùå Connection failed: " + error.message, 'error');
    btn.disabled = false;
  }
});

// Enter key support
document.getElementById("key").addEventListener("keypress", function(e) {
  if (e.key === "Enter") {
    document.getElementById("login").click();
  }
});

function generatePopupHTML(userName, wsURL) {
  return '<!doctype html>\n\
<html>\n\
<head>\n\
<meta charset="utf-8">\n\
<meta name="viewport" content="width=device-width,initial-scale=1">\n\
<title>Remote Browser - ' + userName + '</title>\n\
<style>\n\
 body { \n\
   margin: 0;\n\
   background: #0a0a0a;\n\
   color: #fff;\n\
   font-family: "Segoe UI", Tahoma, sans-serif;\n\
   overflow: hidden;\n\
 }\n\
 \n\
 .toolbar { \n\
   background: linear-gradient(180deg, #1a1a1a 0%, #111 100%);\n\
   padding: 10px;\n\
   display: flex;\n\
   gap: 8px;\n\
   align-items: center;\n\
   border-bottom: 1px solid #333;\n\
   box-shadow: 0 2px 10px rgba(0,0,0,0.5);\n\
 }\n\
 \n\
 .btn { \n\
   background: #2a2a2a;\n\
   border: 1px solid #444;\n\
   color: #fff;\n\
   padding: 8px 12px;\n\
   border-radius: 6px;\n\
   cursor: pointer;\n\
   font-size: 14px;\n\
   transition: all 0.2s;\n\
   min-width: 40px;\n\
 }\n\
 \n\
 .btn:hover {\n\
   background: #3a3a3a;\n\
   border-color: #555;\n\
 }\n\
 \n\
 .btn:active {\n\
   transform: scale(0.95);\n\
 }\n\
 \n\
 .url-bar { \n\
   flex: 1;\n\
   padding: 8px 16px;\n\
   background: #1a1a1a;\n\
   border: 1px solid #444;\n\
   color: #fff;\n\
   border-radius: 20px;\n\
   font-size: 14px;\n\
   outline: none;\n\
   transition: all 0.2s;\n\
 }\n\
 \n\
 .url-bar:focus {\n\
   border-color: #667eea;\n\
   background: #222;\n\
 }\n\
 \n\
 .view-container { \n\
   height: calc(100vh - 60px);\n\
   display: flex;\n\
   align-items: center;\n\
   justify-content: center;\n\
   background: #000;\n\
   position: relative;\n\
 }\n\
 \n\
 .frame-img { \n\
   max-width: 100%;\n\
   max-height: 100%;\n\
   object-fit: contain;\n\
   user-select: none;\n\
   cursor: pointer;\n\
   box-shadow: 0 0 30px rgba(0,0,0,0.8);\n\
 }\n\
 \n\
 .status-overlay {\n\
   position: absolute;\n\
   top: 50%;\n\
   left: 50%;\n\
   transform: translate(-50%, -50%);\n\
   background: rgba(0,0,0,0.9);\n\
   padding: 30px;\n\
   border-radius: 12px;\n\
   text-align: center;\n\
   min-width: 250px;\n\
 }\n\
 \n\
 .spinner {\n\
   border: 3px solid rgba(255,255,255,.1);\n\
   border-left-color: #667eea;\n\
   border-radius: 50%;\n\
   width: 40px;\n\
   height: 40px;\n\
   animation: spin 1s linear infinite;\n\
   margin: 0 auto 15px;\n\
 }\n\
 \n\
 @keyframes spin {\n\
   to { transform: rotate(360deg); }\n\
 }\n\
 \n\
 .user-badge {\n\
   background: #667eea;\n\
   color: #fff;\n\
   padding: 6px 12px;\n\
   border-radius: 12px;\n\
   font-size: 12px;\n\
   font-weight: 600;\n\
 }\n\
 \n\
 .error-msg {\n\
   color: #ff6b6b;\n\
   padding: 10px;\n\
   background: rgba(255,107,107,0.1);\n\
   border-radius: 6px;\n\
   margin-top: 10px;\n\
 }\n\
</style>\n\
</head>\n\
<body>\n\
\n\
<div class="toolbar">\n\
  <button id="back" class="btn" title="Back">‚óÄ</button>\n\
  <button id="forward" class="btn" title="Forward">‚ñ∂</button>\n\
  <button id="refresh" class="btn" title="Refresh">‚Üª</button>\n\
  <input id="url" class="url-bar" placeholder="Enter URL (e.g., example.com)">\n\
  <button id="go" class="btn" style="background:#667eea">Go</button>\n\
  <span class="user-badge">' + userName + '</span>\n\
</div>\n\
\n\
<div id="view" class="view-container">\n\
  <div class="status-overlay">\n\
    <div class="spinner"></div>\n\
    <div>Connecting to server...</div>\n\
    <div id="error" class="error-msg" style="display:none"></div>\n\
  </div>\n\
</div>\n\
\n\
<script>\n\
(function() {\n\
  var ws = null;\n\
  var reconnectAttempts = 0;\n\
  var MAX_RECONNECT = 3;\n\
  \n\
  function showError(msg) {\n\
    var err = document.getElementById("error");\n\
    err.textContent = msg;\n\
    err.style.display = "block";\n\
  }\n\
  \n\
  function connect() {\n\
    ws = new WebSocket("' + wsURL + '");\n\
    ws.binaryType = "arraybuffer";\n\
\n\
    ws.onopen = function() {\n\
      console.log("WebSocket connected");\n\
      reconnectAttempts = 0;\n\
      ws.send(JSON.stringify({ \n\
        type: "control",\n\
        action: "create",\n\
        userName: "' + userName + '"\n\
      }));\n\
    };\n\
\n\
    ws.onmessage = function(e) {\n\
      if (typeof e.data === "string") {\n\
        try {\n\
          var j = JSON.parse(e.data);\n\
          \n\
          if (j.type === "info" && j.action === "created") {\n\
            ws.send(JSON.stringify({ \n\
              type: "control",\n\
              action: "startStream"\n\
            }));\n\
          }\n\
          \n\
          if (j.type === "error") {\n\
            showError("Server error: " + j.message);\n\
          }\n\
        } catch (err) {\n\
          console.error("Error parsing message:", err);\n\
        }\n\
        return;\n\
      }\n\
\n\
      var blob = new Blob([e.data], { type: "image/jpeg" });\n\
      var url = URL.createObjectURL(blob);\n\
\n\
      var view = document.getElementById("view");\n\
      view.innerHTML = "<img id=\\"frame\\" class=\\"frame-img\\" src=\\"" + url + "\\">";\n\
\n\
      setTimeout(function() { URL.revokeObjectURL(url); }, 10000);\n\
\n\
      var img = document.getElementById("frame");\n\
      img.onclick = function(ev) {\n\
        var r = img.getBoundingClientRect();\n\
        var x = Math.round((ev.clientX - r.left) * (1366 / r.width));\n\
        var y = Math.round((ev.clientY - r.top) * (768 / r.height));\n\
        \n\
        if (ws && ws.readyState === WebSocket.OPEN) {\n\
          ws.send(JSON.stringify({ \n\
            type: "control",\n\
            action: "click",\n\
            x: x,\n\
            y: y\n\
          }));\n\
        }\n\
      };\n\
    };\n\
\n\
    ws.onerror = function(error) {\n\
      console.error("WebSocket error:", error);\n\
      showError("Connection error occurred");\n\
    };\n\
\n\
    ws.onclose = function() {\n\
      console.log("WebSocket closed");\n\
      \n\
      if (reconnectAttempts < MAX_RECONNECT) {\n\
        reconnectAttempts++;\n\
        showError("Connection lost. Reconnecting... (" + reconnectAttempts + "/" + MAX_RECONNECT + ")");\n\
        setTimeout(connect, 2000 * reconnectAttempts);\n\
      } else {\n\
        showError("Failed to connect after multiple attempts. Please refresh.");\n\
      }\n\
    };\n\
  }\n\
\n\
  connect();\n\
\n\
  document.getElementById("go").onclick = function() {\n\
    var u = document.getElementById("url").value.trim();\n\
    if (!u) return;\n\
    if (!/^https?:\\/\\//i.test(u)) u = "https://" + u;\n\
    \n\
    if (ws && ws.readyState === WebSocket.OPEN) {\n\
      ws.send(JSON.stringify({ \n\
        type: "control",\n\
        action: "navigate",\n\
        url: u\n\
      }));\n\
    }\n\
  };\n\
\n\
  document.getElementById("url").addEventListener("keypress", function(e) {\n\
    if (e.key === "Enter") {\n\
      document.getElementById("go").click();\n\
    }\n\
  });\n\
\n\
  document.getElementById("back").onclick = function() {\n\
    if (ws && ws.readyState === WebSocket.OPEN) {\n\
      ws.send(JSON.stringify({ type: "control", action: "back" }));\n\
    }\n\
  };\n\
\n\
  document.getElementById("forward").onclick = function() {\n\
    if (ws && ws.readyState === WebSocket.OPEN) {\n\
      ws.send(JSON.stringify({ type: "control", action: "forward" }));\n\
    }\n\
  };\n\
\n\
  document.getElementById("refresh").onclick = function() {\n\
    var u = document.getElementById("url").value.trim();\n\
    if (u && ws && ws.readyState === WebSocket.OPEN) {\n\
      ws.send(JSON.stringify({ \n\
        type: "control",\n\
        action: "navigate",\n\
        url: u\n\
      }));\n\
    }\n\
  };\n\
\n\
  document.getElementById("view").addEventListener("wheel", function(ev) {\n\
    ev.preventDefault();\n\
    if (ws && ws.readyState === WebSocket.OPEN) {\n\
      ws.send(JSON.stringify({\n\
        type: "control",\n\
        action: "scroll",\n\
        dx: 0,\n\
        dy: Math.round(ev.deltaY)\n\
      }));\n\
    }\n\
  }, { passive: false });\n\
\n\
  document.addEventListener("keydown", function(e) {\n\
    if (document.activeElement.id === "url") return;\n\
    \n\
    if (ws && ws.readyState === WebSocket.OPEN) {\n\
      ws.send(JSON.stringify({\n\
        type: "control",\n\
        action: "type",\n\
        text: e.key\n\
      }));\n\
    }\n\
  });\n\
\n\
  window.addEventListener("beforeunload", function() {\n\
    if (ws && ws.readyState === WebSocket.OPEN) {\n\
      ws.send(JSON.stringify({ type: "control", action: "close" }));\n\
      ws.close();\n\
    }\n\
  });\n\
})();\n\
</script>\n\
\n\
</body>\n\
</html>';
}
</script>

</body>
</html>