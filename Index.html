<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Render Proxy ‚Äî Login</title>
  <style>
    :root{ --accent: #4a5de6; --bg1: linear-gradient(135deg,#5568e6 0%,#6b3fa0 100%); --card-bg:#fff; --muted:#7a7a7a; --success:#28c36b }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;font-family: "Segoe UI", Tahoma, sans-serif;background:var(--bg1);-webkit-font-smoothing:antialiased;overflow-x:hidden}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:28px}
    .card{width:100%;max-width:920px;display:grid;grid-template-columns:1fr 480px;gap:24px;align-items:stretch;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.25);overflow:hidden}
    @media (max-width:900px){ .card{grid-template-columns:1fr;max-width:640px} }
    .panel-left{padding:36px;background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)); color:white}
    .logo{font-size:22px;font-weight:700;color:#fff;display:flex;gap:10px;align-items:center}
    .hero-title{font-size:28px;margin-top:18px;color:#fff;font-weight:700}
    .hero-sub{color:var(--muted);margin-top:8px;font-size:14px}
    .info-box{background:rgba(255,255,255,0.05);border-left:4px solid rgba(255,255,255,0.12);padding:12px;margin-top:18px;border-radius:8px}
    .preview{height:100%;background:#0b0b0b;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#999;font-size:14px;overflow:hidden}
    .panel-right{background:var(--card-bg);padding:32px;min-width:320px}
    h1{margin:0;font-size:22px;color:var(--accent);text-align:center}
    .subtitle{font-size:13px;color:#666;text-align:center;margin-top:4px;margin-bottom:16px}
    .form-group{margin-bottom:14px}
    label{display:block;font-size:13px;color:#333;margin-bottom:6px;font-weight:600}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #e6e6e6;font-size:15px}
    input[type="text"]:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px rgba(74,93,230,.06)}
    .btn{padding:12px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--accent);color:white;width:100%;margin-top:8px}
    .btn-wakeup{background:#ffd34d;color:#222;width:100%;margin-top:10px}
    .btn-launch{background:var(--success);color:white;width:100%;padding:12px;border-radius:10px;font-size:16px;font-weight:800;display:none;margin-top:18px}
    .status{display:none;margin-top:16px;padding:12px;border-radius:8px;font-weight:700;text-align:center}
    .status.valid{background:#e6fbec;color:#056632;display:block}
    .status.invalid{background:#ffe9e9;color:#7b1f1f;display:block}
    .status.loading{background:#fff7e6;color:#7a5a00;display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main">
      <div class="panel-left">
        <div class="logo">üåê Render Proxy</div>
        <div class="hero-title">Fast remote browsing</div>
        <div class="hero-sub">Optimized for Chromebooks and WebP streaming.</div>
        <div class="info-box"><small>Server may take a moment to wake. Click Wake if needed.</small></div>
        <div class="preview" id="previewPane"><div><div style="font-weight:700;margin-bottom:8px">Preview</div><div style="color:#999;font-size:12px">Remote browser opens in a new tab.</div></div></div>
      </div>

      <div class="panel-right">
        <h1>Proxy Login</h1>
        <div class="subtitle">Enter your name and key</div>
        <div id="loginForm">
          <div class="form-group">
            <label for="nameInput">First & Last</label>
            <input id="nameInput" type="text" placeholder="John Doe" autocomplete="off">
          </div>
          <div class="form-group">
            <label for="keyInput">Access Key</label>
            <input id="keyInput" type="text" placeholder="Enter your key" autocomplete="off">
          </div>
          <button class="btn btn-primary" id="loginBtn" onclick="authenticate()">Login</button>
          <button class="btn btn-wakeup" id="wakeBtn" onclick="wakeUpServer()">‚òï Wake</button>
          <div class="status" id="status"></div>
        </div>
        <button class="btn-launch" id="launchBtn" onclick="launchProxy()">üöÄ Launch Proxy Browser</button>
      </div>
    </div>
  </div>

<script>
const BACKEND_BASE = "https://render-repo-osyl.onrender.com/";
let userName = "";

function el(id){ return document.getElementById(id); }
function showStatus(msg, type){
  const s = el("status");
  s.textContent = msg;
  s.className = "status " + type;
}

async function wakeUpServer(){
  showStatus("Pinging server...", "loading");
  try {
    const r = await fetch(BACKEND_BASE + "/health");
    const j = await r.json();
    if (j.status === "ok") showStatus("Server awake!", "valid");
    else showStatus("Server responded but not OK", "invalid");
  } catch(e){ showStatus("Server unreachable", "invalid"); }
}

async function authenticate(){
  const name = el("nameInput").value.trim();
  const key = el("keyInput").value.trim();
  if (!name || !key){ showStatus("Fill both fields", "invalid"); return; }
  showStatus("Checking...", "loading");
  try{
    const r = await fetch(`${BACKEND_BASE}/validate?name=${encodeURIComponent(name)}&key=${encodeURIComponent(key)}`);
    const j = await r.json();
    if (j.valid){
      userName = name;
      showStatus(`Welcome, ${name}`, "valid");
      el("loginForm").style.display = "none";
      el("launchBtn").style.display = "block";
    } else showStatus("Invalid name or key", "invalid");
  } catch(e){ showStatus("Connection error", "invalid"); }
}

function launchProxy(){
  const w = window.open("", "_blank");
  if (!w){ alert("Enable popups"); return; }
  const html = createProxyHTML();
  w.document.open();
  w.document.write(html);
  w.document.close();
}

function createProxyHTML(){
  return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Remote Browser - ${userName}</title>
<style>
  :root{ --accent:#4a5de6; --bg:#0b0b0b }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Segoe UI, Tahoma, sans-serif}
  .toolbar{display:flex;gap:8px;align-items:center;padding:10px;background:#121212;border-bottom:1px solid #222}
  .btn{background:#1f1f1f;border:1px solid #2b2b2b;color:#ddd;padding:8px 10px;border-radius:8px;cursor:pointer}
  .btn.primary{background:var(--accent);border:none;color:#fff}
  .url-wrap{display:flex;flex:1;align-items:center;gap:8px}
  .url-input{flex:1;padding:10px 14px;border-radius:999px;border:1px solid #333;background:#0e0e0e;color:#fff;font-size:14px}
  .icon{width:18px;height:18px;display:inline-block}
  select{padding:8px;border-radius:8px;background:#0d0d0d;color:#fff;border:1px solid #333}
  .view{height:calc(100vh - 56px);background:#000;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
  .view img{max-width:100%;max-height:100%;object-fit:contain;cursor:pointer}
  .status{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,0.6);padding:6px 10px;border-radius:8px;font-size:13px;color:#ccc}
</style>
</head>
<body>
  <div class="toolbar">
    <button id="backBtn" class="btn" title="Back">‚óÄ</button>
    <button id="forwardBtn" class="btn" title="Forward">‚ñ∂</button>
    <div class="url-wrap">
      <input id="urlInput" class="url-input" placeholder="Enter URL (e.g. example.com)" list="autocomplete">
    </div>
    <button id="goBtn" class="btn primary">Go</button>
    <button id="refreshBtn" class="btn">‚ü≤</button>
    <select id="qualitySelect">
      <option value="low">Low</option>
      <option value="medium" selected>Medium</option>
      <option value="high">High</option>
    </select>
  </div>

  <div class="view" id="browserContent">
    <div class="status" id="statusBar">Initializing...</div>
  </div>

<script>
  const BASE = "${BACKEND_BASE}";
  let sessionId = null;
  let quality = 'medium';
  let hasNavigated = false;
  let isLoading = false;

  async function createSession(){
    updateStatus('Creating session...');
    try{
      const controller = new AbortController();
      const timeout = setTimeout(()=>controller.abort(),60000);
      const res = await fetch(BASE + '/session/create',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userName: '${userName}', userKey: 'unknown' }), signal: controller.signal
      });
      clearTimeout(timeout);
      if(!res.ok) throw new Error('Create session failed: '+res.status);
      const j = await res.json();
      if(j.success && j.sessionId){ sessionId = j.sessionId; updateStatus('Session ready'); }
      else throw new Error(j.error || 'Unknown');
    }catch(err){
      console.error('createSession error',err);
      updateStatus('Session error: '+(err.name==='AbortError'?'Timed out':'Failed'));
      document.getElementById('browserContent').innerHTML = '<div style="color:#f66;padding:20px;text-align:center">Failed to create session<br><button id="retryBtn" style="margin-top:12px;padding:8px 12px">Retry</button></div>';
      const rb = document.getElementById('retryBtn'); if(rb) rb.onclick = ()=>{ document.getElementById('browserContent').innerHTML = '<div class="status">Initializing...</div>'; createSession(); }
    }
  }

  function updateStatus(msg){ const s = document.getElementById('statusBar'); if(s) s.textContent = msg; }

  async function navigate(){
    if(!sessionId) return;
    let url = document.getElementById('urlInput').value.trim();
    if(!url) return;
    if(!/^https?:\/\//i.test(url)) url = 'https://' + url;
    isLoading = true; updateStatus('Loading...');
    try{
      const r = await fetch(BASE + '/session/navigate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sessionId, url }) });
      const j = await r.json();
      if(j.success){ hasNavigated = true; updateStatus(j.title || j.url || 'Loaded'); setTimeout(()=>updateScreenshot(),400); }
      else updateStatus('Navigation failed');
    }catch(e){ console.error(e); updateStatus('Navigation error'); }
    finally{ isLoading = false; }
  }

  async function goBack(){ if(!sessionId) return; try{ const r = await fetch(BASE + '/session/back', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sessionId }) }); const j = await r.json(); if(j.success) { updateStatus('Went back'); setTimeout(()=>updateScreenshot(),200); } else updateStatus('Back failed'); }catch(e){ updateStatus('Back error'); }}
  async function goForward(){ if(!sessionId) return; try{ const r = await fetch(BASE + '/session/forward', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sessionId }) }); const j = await r.json(); if(j.success) { updateStatus('Went forward'); setTimeout(()=>updateScreenshot(),200); } else updateStatus('Forward failed'); }catch(e){ updateStatus('Forward error'); }}

  async function updateScreenshot(){
    if(!sessionId) return;
    if(!hasNavigated) return; // avoid screenshot loop
    try{
      isLoading = true; updateStatus('Updating image...');
      const r = await fetch(BASE + '/session/screenshot/' + sessionId + '?quality=' + encodeURIComponent(quality), { cache: 'no-store' });
      if(!r.ok) { updateStatus('Screenshot error'); return; }
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const c = document.getElementById('browserContent');
      c.innerHTML = '<img id="simg" src="'+url+'">';
      const img = document.getElementById('simg');
      img.onclick = handleClick;
      // revoke after a bit
      setTimeout(()=>{ try{ URL.revokeObjectURL(url); }catch{} },20000);
      updateStatus('Ready');
    }catch(e){ console.error(e); updateStatus('Screenshot failed'); }finally{ isLoading = false; }
  }

  async function handleClick(e){ if(!sessionId || isLoading) return; const rect = e.target.getBoundingClientRect(); const x = Math.round((e.clientX - rect.left) * (1366 / rect.width)); const y = Math.round((e.clientY - rect.top) * (768 / rect.height)); updateStatus('Clicking...'); try{ await fetch(BASE + '/session/click', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sessionId, x, y }) }); setTimeout(()=>updateScreenshot(),250); }catch(e){ updateStatus('Click failed'); } }

  // Scroll handling
  function initScroll(){ const view = document.getElementById('browserContent'); if(!view) return; view.addEventListener('wheel', async (ev)=>{ ev.preventDefault(); if(!sessionId) return; try{ await fetch(BASE + '/session/scroll', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sessionId, dx: 0, dy: Math.round(ev.deltaY) }) }); setTimeout(()=>updateScreenshot(),120); }catch(e){ /* ignore */ } }, { passive: false }); }

  // Autocomplete
  function initAutocomplete(){ const urlInput = document.getElementById('urlInput'); if(!urlInput) return; let store = JSON.parse(localStorage.getItem('proxy_ac')||'[]'); // attach datalist
    let dl = document.getElementById('autocomplete'); if(!dl){ dl = document.createElement('datalist'); dl.id = 'autocomplete'; document.body.appendChild(dl); }
    dl.innerHTML = ''; store.forEach(v=>{ const o = document.createElement('option'); o.value = v; dl.appendChild(o); }); urlInput.setAttribute('list','autocomplete');
    document.getElementById('goBtn').addEventListener('click',()=>{ const u = urlInput.value.trim(); if(u && !store.includes(u)){ store.unshift(u); if(store.length>50) store.pop(); localStorage.setItem('proxy_ac', JSON.stringify(store)); const o = document.createElement('option'); o.value = u; dl.appendChild(o); } }); }

  // Keyboard typing: send characters to backend when not focused on URL
  function initTyping(){ document.addEventListener('keydown', async (e)=>{ const active = document.activeElement; if(active && active.id === 'urlInput') return; if(!sessionId || !hasNavigated) return; // filter special keys
    if(e.key.length === 1 || e.key === 'Enter' || e.key === 'Backspace' || e.key === 'Tab'){
      try{ await fetch(BASE + '/session/type', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sessionId, text: e.key }) }); if(e.key === 'Enter') setTimeout(()=>updateScreenshot(),120); }catch(err){}
    }
  }); }

  // Wire UI
  document.getElementById('goBtn').addEventListener('click', navigate);
  document.getElementById('refreshBtn').addEventListener('click', ()=>updateScreenshot());
  document.getElementById('qualitySelect').addEventListener('change', (e)=>{ quality = e.target.value; updateScreenshot(); });
  document.getElementById('backBtn').addEventListener('click', ()=>goBack());
  document.getElementById('forwardBtn').addEventListener('click', ()=>goForward());

  window.addEventListener('beforeunload', ()=>{ if(sessionId){ navigator.sendBeacon(BASE + '/session/close', JSON.stringify({ sessionId })); } });

  // Init
  createSession().then(()=>{ initScroll(); initAutocomplete(); initTyping(); });
// === Textarea overlay for full typing ===
  function initTextOverlay(){
    const overlay = document.createElement('textarea');
    overlay.id = 'typingOverlay';
    overlay.style.position = 'fixed';
    overlay.style.bottom = '12px';
    overlay.style.right = '12px';
    overlay.style.width = '260px';
    overlay.style.height = '120px';
    overlay.style.background = 'rgba(0,0,0,0.65)';
    overlay.style.color = '#fff';
    overlay.style.border = '1px solid #333';
    overlay.style.borderRadius = '8px';
    overlay.style.padding = '8px';
    overlay.style.fontSize = '14px';
    overlay.placeholder = 'Type here ‚Üí auto-sent to remote browser';

    let lastValue = '';
    overlay.addEventListener('input', async ()=>{
      const text = overlay.value.replace(lastValue, '');
      lastValue = overlay.value;
      if(text.trim().length > 0){
        await fetch(BASE + '/session/type',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body: JSON.stringify({sessionId,text})
        });
        setTimeout(()=>updateScreenshot(),150);
      }
    });

    document.body.appendChild(overlay);
  }

  // Re-init after session creation
  createSession().then(()=>{ initScroll(); initAutocomplete(); initTyping(); initTextOverlay(); });
</script>
</body>
</html>`;
}


async function navigate(){
  let url=document.getElementById("urlInput").value.trim();
  if(!/^https?:\/\//i.test(url)) url="https://"+url;
  hasNavigated = true;
  await fetch(BASE+"/session/navigate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId,url})});
  updateScreenshot();
}

document.getElementById("goBtn").onclick=navigate;
document.getElementById("refreshBtn").onclick=updateScreenshot;
document.getElementById("qualitySelect").onchange=e=>{quality=e.target.value;updateScreenshot();}

let hasNavigated = false;

async function updateScreenshot(){
  if (!hasNavigated) return; // Prevent looping before first navigation

  const r=await fetch(BASE+"/session/screenshot/"+sessionId+"?quality="+quality,{cache:"no-store"});
  const b=await r.blob();
  const u=URL.createObjectURL(b);
  const c=document.getElementById("browserContent");
  c.innerHTML='<img id="img" src="'+u+'">';
  document.getElementById("img").onclick=handleClick;
}

async function handleClick(e){
  const rect=e.target.getBoundingClientRect();
  const x=(e.clientX-rect.left)*(1366/rect.width);
  const y=(e.clientY-rect.top)*(768/rect.height);
  await fetch(BASE+"/session/click",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId,x,y})});
  updateScreenshot();
}

createSession();
<\/script>
<script>
// --- Autocomplete & Scroll Support Added ---
function popupEnhancements(){
  const urlInput = document.getElementById('urlInput');
  if(urlInput){
    // Autocomplete list
    let store = JSON.parse(localStorage.getItem('proxy_ac')||'[]');
    let dl = document.createElement('datalist');
    dl.id = 'autocomplete';
    store.forEach(v=>{let o=document.createElement('option');o.value=v;dl.appendChild(o);});
    document.body.appendChild(dl);
    urlInput.setAttribute('list','autocomplete');
    const go = document.getElementById('goBtn');
    if(go){go.addEventListener('click',()=>{
      let u=urlInput.value.trim();
      if(u && !store.includes(u)){ store.push(u); localStorage.setItem('proxy_ac',JSON.stringify(store)); }
    });}
  }

  // Scroll wheel support
  const view = document.getElementById('browserContent');
  if(view){
    view.addEventListener('wheel', async (e)=>{
      e.preventDefault();
      try{
        await fetch(BASE+'/session/scroll',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({sessionId,dx:0,dy:e.deltaY})
        });
      }catch(err){}
      updateScreenshot();
    },{passive:false});
  }
}

document.addEventListener('DOMContentLoaded', popupEnhancements);
</script>
</body></html>`;
}
</script>
</body>
</html>
