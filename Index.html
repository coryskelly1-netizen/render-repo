<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Unified Multi-Browser System</title>
<style>
  * { box-sizing: border-box; }
  body { 
    font-family: 'Segoe UI', Tahoma, sans-serif; 
    margin:0; 
    background:#0a0e27; 
    color:#fff; 
    overflow:hidden;
  }
  
  .login-overlay {
    position:fixed;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:rgba(10,14,39,0.98);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:1000;
  }
  .login-overlay.hidden { display:none; }
  
  .login-box {
    max-width:400px;
    width:90%;
    padding:30px;
    background:#1a1f3a;
    border-radius:12px;
    box-shadow:0 20px 60px rgba(0,0,0,0.5);
  }
  .login-box h1 { 
    margin:0 0 10px 0; 
    font-size:24px;
    text-align:center;
  }
  .login-box .subtitle {
    text-align:center;
    opacity:0.7;
    font-size:13px;
    margin-bottom:20px;
  }
  input { 
    width:100%; 
    padding:12px; 
    border-radius:8px; 
    border:1px solid #2d3748; 
    background:#0f1419;
    color:#fff;
    margin-top:8px; 
    font-size:14px;
  }
  button { 
    width:100%; 
    padding:12px; 
    border-radius:8px; 
    border:0; 
    background:#4a5de6; 
    color:#fff; 
    margin-top:12px; 
    cursor:pointer; 
    font-weight:700;
    transition: all 0.2s;
    font-size:14px;
  }
  button:hover { background:#5a6df6; transform:translateY(-1px); }
  button:disabled { background:#2d3748; cursor:not-allowed; }
  
  .status { 
    padding:10px; 
    border-radius:8px; 
    margin-top:10px; 
    display:none;
    font-size:12px;
  }
  .status.show { display:block; }
  .status.info { background:#1e3a5f; color:#60a5fa; }
  .status.success { background:#1e3d2f; color:#4ade80; }
  .status.error { background:#3d1e1e; color:#f87171; }
  
  .main-screen {
    height:100vh;
    display:flex;
    flex-direction:column;
  }
  
  .top-bar {
    background:#1a1f3a;
    padding:10px 20px;
    display:flex;
    align-items:center;
    gap:10px;
    border-bottom:2px solid #2d3748;
    flex-shrink:0;
  }
  .top-bar h1 {
    margin:0;
    font-size:18px;
    color:#4a5de6;
    white-space:nowrap;
  }
  .url-bar {
    flex:1;
    display:flex;
    gap:8px;
  }
  .url-bar input {
    flex:1;
    margin:0;
    padding:10px;
    font-size:13px;
  }
  .url-bar button {
    width:auto;
    margin:0;
    padding:10px 20px;
    font-size:13px;
  }
  .stats-bar {
    display:flex;
    gap:15px;
    font-size:12px;
    margin-left:auto;
    padding-left:20px;
  }
  .stat {
    white-space:nowrap;
  }
  .stat-value {
    color:#4a5de6;
    font-weight:700;
  }
  
  .browser-grid-container {
    flex:1;
    padding:10px;
    overflow:auto;
  }
  .browser-grid {
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(400px, 1fr));
    gap:10px;
    height:100%;
  }
  
  .browser-frame {
    background:#000;
    border-radius:8px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    border:2px solid #2d3748;
    transition:border-color 0.3s;
  }
  .browser-frame.connected { border-color:#4ade80; }
  .browser-frame.error { border-color:#f87171; }
  .browser-frame.active { border-color:#4a5de6; box-shadow:0 0 20px rgba(74,93,230,0.4); }
  
  .frame-header {
    background:#1a1f3a;
    padding:8px 12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-shrink:0;
  }
  .frame-title {
    font-size:12px;
    font-weight:700;
    color:#4a5de6;
  }
  .frame-status {
    font-size:10px;
    padding:3px 8px;
    border-radius:999px;
    background:#2d3748;
  }
  .frame-status.online { background:#1e3d2f; color:#4ade80; }
  .frame-status.offline { background:#3d1e1e; color:#f87171; }
  
  .frame-viewport {
    flex:1;
    position:relative;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:crosshair;
    min-height:300px;
    overflow:hidden;
  }
  .frame-viewport img {
    width:100%;
    height:100%;
    object-fit:contain;
    display:block;
  }
  .frame-viewport .placeholder {
    color:#666;
    font-size:13px;
    text-align:center;
  }
  
  .frame-controls {
    background:#0f1419;
    padding:6px;
    display:flex;
    gap:4px;
    flex-shrink:0;
  }
  .frame-controls button {
    flex:1;
    margin:0;
    padding:6px;
    font-size:11px;
  }
  
  @media (max-width: 1200px) {
    .browser-grid {
      grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));
    }
  }
</style>
</head>
<body>

<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h1>‚ö° Multi-Browser Control</h1>
    <div class="subtitle">Control all browsers simultaneously</div>
    
    <input id="name" placeholder="Your name" value="Alice">
    <input id="key" placeholder="Access key" type="password" value="8392017">
    
    <button id="wakeBtn" style="background:#ffd34d;color:#000">‚òï Wake All Servers</button>
    <button id="launchBtn">üöÄ Launch All Browsers</button>
    <div id="loginStatus" class="status"></div>
  </div>
</div>

<div class="main-screen" id="mainScreen" style="display:none">
  <div class="top-bar">
    <h1>‚ö° Multi-Browser Control</h1>
    <div class="url-bar">
      <input id="globalUrl" placeholder="Navigate all browsers to...">
      <button id="globalGo">Go All</button>
      <button id="globalBack">‚Üê Back</button>
      <button id="globalForward">Forward ‚Üí</button>
    </div>
    <div class="stats-bar">
      <div class="stat">Total: <span class="stat-value" id="statTotal">0</span></div>
      <div class="stat">Online: <span class="stat-value" id="statOnline">0</span></div>
      <div class="stat">Latency: <span class="stat-value" id="statLatency">0ms</span></div>
    </div>
  </div>
  
  <div class="browser-grid-container">
    <div class="browser-grid" id="browserGrid"></div>
  </div>
</div>

<script>
// Add your hosting URLs here
const HOST_POOL = [
  { name: "Render-1", url: "https://render-repo-1-yto6.onrender.com" },
  { name: "Render-2", url: "https://render-repo-0x73.onrender.com" },
  { name: "Render-3", url: "https://render-repo-f64m.onrender.com" },
];

let browsers = new Map(); // hostUrl -> { ws, status, latency, lastFrame, element }
let userName = "";
let activeBrowser = null;

function setStatus(msg, type) {
  const el = document.getElementById("loginStatus");
  el.innerHTML = msg;
  el.className = "status show " + (type||"");
}

function updateStats() {
  const total = browsers.size;
  const online = Array.from(browsers.values()).filter(b => b.status === 'connected').length;
  const latencies = Array.from(browsers.values()).filter(b => b.latency).map(b => b.latency);
  const avgLatency = latencies.length ? Math.round(latencies.reduce((a,b)=>a+b,0) / latencies.length) : 0;
  
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statOnline').textContent = online;
  document.getElementById('statLatency').textContent = avgLatency + 'ms';
}

function createBrowserFrame(host) {
  const frame = document.createElement('div');
  frame.className = 'browser-frame';
  frame.id = 'frame-' + host.url.replace(/[^a-z0-9]/gi, '');
  
  frame.innerHTML = `
    <div class="frame-header">
      <div class="frame-title">${host.name}</div>
      <div class="frame-status">connecting...</div>
    </div>
    <div class="frame-viewport">
      <div class="placeholder">Connecting...</div>
    </div>
    <div class="frame-controls">
      <button onclick="focusBrowser('${host.url}')">üéØ Focus</button>
      <button onclick="reconnectBrowser('${host.url}')">üîÑ Reconnect</button>
      <button onclick="closeBrowser('${host.url}')">‚ùå Close</button>
    </div>
  `;
  
  // Click to focus and interact
  const viewport = frame.querySelector('.frame-viewport');
  viewport.onclick = (e) => {
    if (e.target.tagName === 'IMG') {
      focusBrowser(host.url);
      handleClick(host.url, e);
    }
  };
  
  // Keyboard input when focused
  viewport.setAttribute('tabindex', '0');
  viewport.onkeydown = (e) => {
    const browser = browsers.get(host.url);
    if (!browser || browser.status !== 'connected') return;
    
    if (e.key.length === 1) {
      browser.ws.send(JSON.stringify({type:'control', action:'type', text: e.key}));
      e.preventDefault();
    } else if (e.key === 'Enter') {
      browser.ws.send(JSON.stringify({type:'control', action:'type', text: '\n'}));
      e.preventDefault();
    }
  };
  
  // Scroll support
  viewport.addEventListener('wheel', (e) => {
    const browser = browsers.get(host.url);
    if (!browser || browser.status !== 'connected') return;
    browser.ws.send(JSON.stringify({type:'control', action:'scroll', dy: e.deltaY}));
    e.preventDefault();
  }, {passive: false});
  
  return frame;
}

function handleClick(hostUrl, e) {
  const browser = browsers.get(hostUrl);
  if (!browser || browser.status !== 'connected') return;
  
  const img = e.target;
  const rect = img.getBoundingClientRect();
  const x = Math.round((e.clientX - rect.left) * (1366 / rect.width));
  const y = Math.round((e.clientY - rect.top) * (768 / rect.height));
  
  browser.ws.send(JSON.stringify({type:'control', action:'click', x, y}));
}

function updateBrowserFrame(hostUrl, data) {
  const frameId = 'frame-' + hostUrl.replace(/[^a-z0-9]/gi, '');
  const frame = document.getElementById(frameId);
  if (!frame) return;
  
  const statusEl = frame.querySelector('.frame-status');
  const viewportEl = frame.querySelector('.frame-viewport');
  
  if (data.status === 'connected') {
    frame.className = 'browser-frame connected' + (activeBrowser === hostUrl ? ' active' : '');
    statusEl.className = 'frame-status online';
    statusEl.textContent = `online (${data.latency}ms)`;
  } else if (data.status === 'error') {
    frame.className = 'browser-frame error';
    statusEl.className = 'frame-status offline';
    statusEl.textContent = 'offline';
    viewportEl.innerHTML = '<div class="placeholder">Disconnected</div>';
  } else {
    statusEl.textContent = data.status;
  }
  
  if (data.lastFrame) {
    viewportEl.innerHTML = `<img src="${data.lastFrame}" alt="${data.host.name}">`;
  }
}

function focusBrowser(hostUrl) {
  activeBrowser = hostUrl;
  
  // Update visual states
  document.querySelectorAll('.browser-frame').forEach(f => {
    f.classList.remove('active');
  });
  
  const frameId = 'frame-' + hostUrl.replace(/[^a-z0-9]/gi, '');
  const frame = document.getElementById(frameId);
  if (frame) {
    frame.classList.add('active');
    const viewport = frame.querySelector('.frame-viewport');
    viewport.focus();
  }
}

async function connectBrowser(host) {
  const wsUrl = host.url.replace(/^http/, 'ws') + '/ws';
  
  try {
    const ws = new WebSocket(wsUrl);
    ws.binaryType = 'arraybuffer';
    
    const browserData = {
      ws: ws,
      host: host,
      status: 'connecting',
      latency: null,
      lastFrame: null,
      startTime: Date.now()
    };
    
    browsers.set(host.url, browserData);
    
    ws.onopen = () => {
      console.log(`‚úÖ Connected to ${host.name}`);
      browserData.status = 'authenticating';
      ws.send(JSON.stringify({type:'control', action:'create', userName: userName}));
    };
    
    ws.onmessage = (e) => {
      if (typeof e.data === 'string') {
        try {
          const j = JSON.parse(e.data);
          if (j.type === 'info' && j.action === 'created') {
            browserData.status = 'connected';
            browserData.latency = Date.now() - browserData.startTime;
            ws.send(JSON.stringify({type:'control', action:'startStream'}));
            updateBrowserFrame(host.url, browserData);
            updateStats();
          }
          if (j.type === 'error') {
            console.error(`Error from ${host.name}:`, j.message);
            browserData.status = 'error';
            updateBrowserFrame(host.url, browserData);
          }
        } catch (err) {}
        return;
      }
      
      // Handle frame
      const blob = new Blob([e.data], { type: 'image/jpeg' });
      const url = URL.createObjectURL(blob);
      
      // Revoke old frame
      if (browserData.lastFrame) {
        URL.revokeObjectURL(browserData.lastFrame);
      }
      
      browserData.lastFrame = url;
      updateBrowserFrame(host.url, browserData);
    };
    
    ws.onerror = () => {
      console.error(`Connection error: ${host.name}`);
      browserData.status = 'error';
      updateBrowserFrame(host.url, browserData);
      updateStats();
    };
    
    ws.onclose = () => {
      console.log(`Disconnected: ${host.name}`);
      browserData.status = 'disconnected';
      updateBrowserFrame(host.url, browserData);
      updateStats();
    };
    
  } catch (err) {
    console.error(`Failed to connect to ${host.name}:`, err);
  }
}

async function validateAndLaunch() {
  const name = document.getElementById('name').value.trim();
  const key = document.getElementById('key').value.trim();
  
  if (!name || !key) {
    setStatus("‚ùå Enter name and key", "error");
    return;
  }
  
  userName = name;
  setStatus("üîç Validating credentials...", "info");
  
  // Validate with first available host
  let validated = false;
  for (const host of HOST_POOL) {
    try {
      const r = await fetch(host.url + "/validate?name=" + encodeURIComponent(name) + "&key=" + encodeURIComponent(key));
      const j = await r.json();
      if (j.valid) {
        validated = true;
        break;
      }
    } catch (e) {
      continue;
    }
  }
  
  if (!validated) {
    setStatus("‚ùå Invalid credentials", "error");
    return;
  }
  
  // Hide login, show main screen
  document.getElementById('loginOverlay').classList.add('hidden');
  document.getElementById('mainScreen').style.display = 'flex';
  
  // Create browser frames and connect to ALL hosts simultaneously
  const grid = document.getElementById('browserGrid');
  grid.innerHTML = '';
  
  for (const host of HOST_POOL) {
    grid.appendChild(createBrowserFrame(host));
    connectBrowser(host);
  }
  
  updateStats();
}

function sendToAll(action, data) {
  browsers.forEach((browser, hostUrl) => {
    if (browser.status === 'connected' && browser.ws.readyState === WebSocket.OPEN) {
      browser.ws.send(JSON.stringify({type:'control', action, ...data}));
    }
  });
}

window.reconnectBrowser = async (hostUrl) => {
  closeBrowser(hostUrl);
  const host = HOST_POOL.find(h => h.url === hostUrl);
  if (host) {
    setTimeout(() => connectBrowser(host), 500);
  }
};

window.closeBrowser = (hostUrl) => {
  const browser = browsers.get(hostUrl);
  if (browser && browser.ws) {
    try {
      browser.ws.send(JSON.stringify({type:'control', action:'close'}));
      browser.ws.close();
    } catch(e) {}
    if (browser.lastFrame) {
      URL.revokeObjectURL(browser.lastFrame);
    }
  }
  browsers.delete(hostUrl);
  updateStats();
  
  // Remove frame from grid
  const frameId = 'frame-' + hostUrl.replace(/[^a-z0-9]/gi, '');
  const frame = document.getElementById(frameId);
  if (frame) frame.remove();
};

window.focusBrowser = focusBrowser;

// Wake servers button
document.getElementById('wakeBtn').addEventListener('click', async () => {
  setStatus("‚òï Waking all servers...", "info");
  
  let online = 0;
  let offline = 0;
  
  const checks = HOST_POOL.map(async (host) => {
    try {
      const r = await fetch(host.url + "/health", { cache: 'no-store' });
      const j = await r.json();
      if (j.status === "ok") {
        online++;
        return `‚úÖ ${host.name}: Online`;
      } else {
        offline++;
        return `‚ö†Ô∏è ${host.name}: Not OK`;
      }
    } catch (e) {
      offline++;
      return `‚ùå ${host.name}: Offline`;
    }
  });
  
  const results = await Promise.all(checks);
  const summary = results.join('<br>');
  
  setStatus(`<strong>Server Status:</strong><br>${summary}<br><br><strong>Online: ${online} / ${HOST_POOL.length}</strong>`, 
    online === HOST_POOL.length ? "success" : (online > 0 ? "info" : "error"));
});

// Event listeners
document.getElementById('launchBtn').addEventListener('click', validateAndLaunch);

document.getElementById('globalGo').addEventListener('click', () => {
  let url = document.getElementById('globalUrl').value.trim();
  if (url) {
    if (!/^https?:\/\//i.test(url)) {
      url = 'https://' + url;
    }
    sendToAll('navigate', { url });
  }
});

document.getElementById('globalBack').addEventListener('click', () => {
  sendToAll('back', {});
});

document.getElementById('globalForward').addEventListener('click', () => {
  sendToAll('forward', {});
});

// Global keyboard shortcuts
document.addEventListener('keydown', (e) => {
  // Ctrl/Cmd + Enter to navigate
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    const urlInput = document.getElementById('globalUrl');
    if (document.activeElement === urlInput) {
      document.getElementById('globalGo').click();
    }
  }
});
</script>
</body>
</html>