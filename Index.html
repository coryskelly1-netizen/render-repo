<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Multi-User Browser Proxy</title>
<style>
  * { box-sizing: border-box; }
  body { 
    font-family: 'Segoe UI', Tahoma, sans-serif; 
    margin:0; 
    background:#0a0e27; 
    color:#fff; 
    overflow:hidden;
  }
  
  .login-overlay {
    position:fixed;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:rgba(10,14,39,0.98);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:1000;
  }
  .login-overlay.hidden { display:none; }
  
  .login-box {
    max-width:400px;
    width:90%;
    padding:30px;
    background:#1a1f3a;
    border-radius:12px;
    box-shadow:0 20px 60px rgba(0,0,0,0.5);
  }
  .login-box h1 { 
    margin:0 0 10px 0; 
    font-size:26px;
    text-align:center;
    background:linear-gradient(135deg,#667eea,#764ba2);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }
  .login-box .subtitle {
    text-align:center;
    opacity:0.7;
    font-size:13px;
    margin-bottom:20px;
  }
  
  input { 
    width:100%; 
    padding:12px; 
    border-radius:8px; 
    border:1px solid #2d3748; 
    background:#0f1419;
    color:#fff;
    margin-top:8px; 
    font-size:14px;
  }
  button { 
    width:100%; 
    padding:12px; 
    border-radius:8px; 
    border:0; 
    background:#4a5de6; 
    color:#fff; 
    margin-top:12px; 
    cursor:pointer; 
    font-weight:700;
    transition: all 0.2s;
    font-size:14px;
  }
  button:hover { background:#5a6df6; transform:translateY(-1px); }
  button:disabled { background:#2d3748; cursor:not-allowed; }
  .wake-btn { background:#ffd34d !important; color:#000 !important; }
  
  .status { 
    padding:10px; 
    border-radius:8px; 
    margin-top:10px; 
    display:none;
    font-size:12px;
  }
  .status.show { display:block; }
  .status.info { background:#1e3a5f; color:#60a5fa; }
  .status.success { background:#1e3d2f; color:#4ade80; }
  .status.error { background:#3d1e1e; color:#f87171; }
  
  .main-screen {
    height:100vh;
    display:flex;
    flex-direction:column;
  }
  
  .top-bar {
    background:#1a1f3a;
    padding:10px 20px;
    display:flex;
    align-items:center;
    gap:10px;
    border-bottom:2px solid #2d3748;
    flex-shrink:0;
    z-index:100;
  }
  .top-bar h1 {
    margin:0;
    font-size:16px;
    background:linear-gradient(135deg,#667eea,#764ba2);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    white-space:nowrap;
    font-weight:900;
  }
  .url-bar {
    flex:1;
    display:flex;
    gap:8px;
  }
  .url-bar input {
    flex:1;
    margin:0;
    padding:10px;
    font-size:14px;
  }
  .url-bar button {
    width:auto;
    margin:0;
    padding:10px 20px;
    font-size:13px;
  }
  
  .stats-bar {
    display:flex;
    gap:15px;
    font-size:11px;
    color:#888;
    align-items:center;
  }
  .stat-item {
    display:flex;
    align-items:center;
    gap:5px;
  }
  .stat-value {
    color:#4ade80;
    font-weight:700;
  }
  .backend-indicators {
    display:flex;
    gap:4px;
  }
  .backend-dot {
    width:8px;
    height:8px;
    border-radius:50%;
    background:#2d3748;
    position:relative;
  }
  .backend-dot.active { 
    background:#4ade80; 
    animation:pulse 2s infinite; 
  }
  .backend-dot.rendering {
    background:#4a5de6;
    box-shadow:0 0 8px #4a5de6;
  }
  
  @keyframes pulse {
    0%, 100% { opacity:1; }
    50% { opacity:0.5; }
  }
  
  .browser-viewport {
    flex:1;
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    overflow:hidden;
  }
  .viewport-canvas {
    max-width:100%;
    max-height:100%;
    object-fit:contain;
    cursor:crosshair;
    box-shadow:0 0 40px rgba(0,0,0,0.8);
    outline:none;
  }
  
  .mode-badge-corner {
    position:absolute;
    top:15px;
    right:15px;
    background:rgba(74,222,128,0.9);
    color:#000;
    padding:8px 16px;
    border-radius:8px;
    font-size:11px;
    font-weight:700;
    pointer-events:none;
    z-index:10;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
  }
</style>
</head>
<body>

<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h1>üöÄ Multi-User Browser</h1>
    <div class="subtitle">Round-robin rendering - Maximum FPS with all 5 backends!</div>
    
    <input id="name" placeholder="Your name" value="Alice">
    <input id="key" placeholder="Access key" type="password" value="8392017">
    
    <button class="wake-btn" id="wakeBtn">‚òï Wake All Servers</button>
    <button id="launchBtn">üöÄ Launch Browser</button>
    <div id="loginStatus" class="status"></div>
  </div>
</div>

<div class="main-screen" id="mainScreen" style="display:none">
  <div class="top-bar">
    <h1>ROUND ROBIN MODE</h1>
    <div class="url-bar">
      <input id="globalUrl" placeholder="Navigate to..." value="https://example.com">
      <button id="globalGo">Go</button>
      <button id="globalBack">‚Üê</button>
      <button id="globalForward">‚Üí</button>
    </div>
    
    <div class="stats-bar">
      <div class="stat-item">
        <span>FPS:</span>
        <span class="stat-value" id="fpsValue">0</span>
      </div>
      <div class="stat-item">
        <span>Latency:</span>
        <span class="stat-value" id="latencyValue">0ms</span>
      </div>
      <div class="stat-item">
        <span>Active:</span>
        <span class="stat-value" id="activeBackend">-</span>
      </div>
      <div class="backend-indicators" id="backendIndicators"></div>
    </div>
  </div>
  
  <div class="browser-viewport" id="browserViewport">
    <canvas id="viewportCanvas" class="viewport-canvas" width="1366" height="768" tabindex="0"></canvas>
    <div class="mode-badge-corner">5x FRAME INTERLEAVING</div>
  </div>
</div>

<script>
const HOST_POOL = [
  { name: "R1", url: "https://render-repo-1-yto6.onrender.com" },
  { name: "R2", url: "https://render-repo-0x73.onrender.com" },
  { name: "R3", url: "https://render-repo-f64m.onrender.com" },
  { name: "R4", url: "https://render-repo-791m.onrender.com" },
  { name: "R5", url: "https://render-repo-l0tw.onrender.com" },
];

const VIEWPORT_WIDTH = 1366;
const VIEWPORT_HEIGHT = 768;

let backends = new Map();
let userName = "";
let canvas = null;
let ctx = null;
let currentRenderingBackend = null;
let backendRotationIndex = 0;

// Performance tracking
let frameStats = { count: 0, lastUpdate: Date.now() };
let latencyStats = [];

function setStatus(msg, type) {
  const el = document.getElementById("loginStatus");
  el.innerHTML = msg;
  el.className = "status show " + (type || "");
}

function initCanvas() {
  canvas = document.getElementById('viewportCanvas');
  ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
  ctx.fillStyle = '#1a1a1a';
  ctx.fillRect(0, 0, VIEWPORT_WIDTH, VIEWPORT_HEIGHT);
  
  canvas.addEventListener('click', handleClick);
  canvas.addEventListener('wheel', handleScroll, { passive: false });
  canvas.addEventListener('keydown', handleKeydown);
  canvas.focus();
}

function handleClick(e) {
  const rect = canvas.getBoundingClientRect();
  const x = Math.round((e.clientX - rect.left) * (VIEWPORT_WIDTH / rect.width));
  const y = Math.round((e.clientY - rect.top) * (VIEWPORT_HEIGHT / rect.height));
  sendCommandToAll('click', { x, y });
  canvas.focus();
}

function handleScroll(e) {
  sendCommandToAll('scroll', { dy: e.deltaY });
  e.preventDefault();
}

function handleKeydown(e) {
  if (e.ctrlKey || e.metaKey) {
    if (e.key === 'l') {
      e.preventDefault();
      document.getElementById('globalUrl').focus();
    }
    return;
  }
  
  if (e.key.length === 1) {
    sendCommandToAll('type', { text: e.key });
    e.preventDefault();
  } else if (e.key === 'Enter') {
    sendCommandToAll('type', { text: '\n' });
    e.preventDefault();
  } else if (e.key === 'Backspace') {
    sendCommandToAll('type', { text: '\b' });
    e.preventDefault();
  } else if (e.key === 'Tab') {
    sendCommandToAll('type', { text: '\t' });
    e.preventDefault();
  }
}

function sendCommandToAll(action, data) {
  backends.forEach(backend => {
    if (backend.status === 'connected' && backend.ws.readyState === WebSocket.OPEN) {
      backend.ws.send(JSON.stringify({ type: 'control', action, ...data }));
    }
  });
}

function getNextBackend() {
  const connectedBackends = Array.from(backends.values()).filter(b => b.status === 'connected');
  if (connectedBackends.length === 0) return null;
  
  const backend = connectedBackends[backendRotationIndex % connectedBackends.length];
  backendRotationIndex = (backendRotationIndex + 1) % connectedBackends.length;
  
  return backend;
}

function updateBackendIndicators() {
  const container = document.getElementById('backendIndicators');
  container.innerHTML = '';
  
  backends.forEach(backend => {
    const dot = document.createElement('div');
    dot.className = 'backend-dot';
    if (backend.status === 'connected') {
      dot.classList.add('active');
      if (backend === currentRenderingBackend) {
        dot.classList.add('rendering');
      }
    }
    dot.title = `${backend.host.name}`;
    container.appendChild(dot);
  });
  
  if (currentRenderingBackend) {
    document.getElementById('activeBackend').textContent = currentRenderingBackend.host.name;
  }
}

function updateStats() {
  const now = Date.now();
  const elapsed = (now - frameStats.lastUpdate) / 1000;
  
  if (elapsed > 1) {
    const fps = Math.round(frameStats.count / elapsed);
    document.getElementById('fpsValue').textContent = fps;
    frameStats.count = 0;
    frameStats.lastUpdate = now;
  }
  
  if (latencyStats.length > 0) {
    const avg = Math.round(latencyStats.reduce((a, b) => a + b, 0) / latencyStats.length);
    document.getElementById('latencyValue').textContent = avg + 'ms';
    latencyStats = latencyStats.slice(-10);
  }
  
  updateBackendIndicators();
}

function renderFrame(backend, imageData) {
  if (!ctx) return;
  
  // Only render from the designated backend for this frame
  if (backend !== currentRenderingBackend) return;
  
  const img = new Image();
  img.onload = () => {
    requestAnimationFrame(() => {
      ctx.drawImage(img, 0, 0, VIEWPORT_WIDTH, VIEWPORT_HEIGHT);
      frameStats.count++;
      
      // Rotate to next backend for next frame
      currentRenderingBackend = getNextBackend();
    });
  };
  img.src = imageData;
}

async function connectBackend(host) {
  const wsUrl = host.url.replace(/^http/, 'ws') + '/ws';
  
  try {
    const ws = new WebSocket(wsUrl);
    ws.binaryType = 'arraybuffer';
    
    const backend = {
      ws,
      host,
      status: 'connecting',
      latency: null,
      startTime: Date.now()
    };
    
    backends.set(host.url, backend);
    
    ws.onopen = () => {
      backend.status = 'authenticating';
      ws.send(JSON.stringify({ type: 'control', action: 'create', userName }));
    };
    
    ws.onmessage = (e) => {
      if (typeof e.data === 'string') {
        const msg = JSON.parse(e.data);
        if (msg.type === 'info' && msg.action === 'created') {
          backend.status = 'connected';
          backend.latency = Date.now() - backend.startTime;
          latencyStats.push(backend.latency);
          
          // Set first backend as current if none set
          if (!currentRenderingBackend) {
            currentRenderingBackend = backend;
          }
          
          // All backends render full screen
          backend.ws.send(JSON.stringify({ type: 'control', action: 'startStream' }));
          
          updateStats();
        }
        return;
      }
      
      // Binary frame data
      const blob = new Blob([e.data], { type: 'image/jpeg' });
      const url = URL.createObjectURL(blob);
      renderFrame(backend, url);
      
      if (backend.lastFrameUrl) {
        setTimeout(() => URL.revokeObjectURL(backend.lastFrameUrl), 500);
      }
      backend.lastFrameUrl = url;
    };
    
    ws.onerror = () => {
      backend.status = 'error';
      updateStats();
    };
    
    ws.onclose = () => {
      backend.status = 'disconnected';
      
      // If current backend disconnected, switch to next
      if (backend === currentRenderingBackend) {
        currentRenderingBackend = getNextBackend();
      }
      
      setTimeout(() => connectBackend(host), 5000);
    };
    
  } catch (err) {
    console.error(`Failed to connect ${host.name}:`, err);
  }
}

async function validateAndLaunch() {
  const name = document.getElementById('name').value.trim();
  const key = document.getElementById('key').value.trim();
  
  if (!name || !key) {
    setStatus("‚ùå Enter credentials", "error");
    return;
  }
  
  userName = name;
  setStatus("üîç Validating...", "info");
  
  let validated = false;
  for (const host of HOST_POOL) {
    try {
      const r = await fetch(host.url + "/validate?name=" + encodeURIComponent(name) + "&key=" + encodeURIComponent(key));
      const j = await r.json();
      if (j.valid) {
        validated = true;
        break;
      }
    } catch (e) {}
  }
  
  if (!validated) {
    setStatus("‚ùå Invalid credentials", "error");
    return;
  }
  
  document.getElementById('loginOverlay').classList.add('hidden');
  document.getElementById('mainScreen').style.display = 'flex';
  
  initCanvas();
  HOST_POOL.forEach(host => connectBackend(host));
}

document.getElementById('wakeBtn').addEventListener('click', async () => {
  setStatus("‚òï Waking servers...", "info");
  let online = 0;
  
  const checks = HOST_POOL.map(async (host) => {
    try {
      const r = await fetch(host.url + "/health", { cache: 'no-store' });
      if ((await r.json()).status === "ok") {
        online++;
        return `‚úÖ ${host.name}`;
      }
    } catch (e) {}
    return `‚ùå ${host.name}`;
  });
  
  const results = await Promise.all(checks);
  setStatus(results.join('<br>') + `<br><br><strong>${online}/${HOST_POOL.length} online</strong>`, 
    online === HOST_POOL.length ? "success" : "info");
});

document.getElementById('launchBtn').addEventListener('click', validateAndLaunch);

document.getElementById('globalGo').addEventListener('click', () => {
  let url = document.getElementById('globalUrl').value.trim();
  if (url && !/^https?:\/\//i.test(url)) url = 'https://' + url;
  if (url) sendCommandToAll('navigate', { url });
});

document.getElementById('globalBack').addEventListener('click', () => sendCommandToAll('back', {}));
document.getElementById('globalForward').addEventListener('click', () => sendCommandToAll('forward', {}));

document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
    e.preventDefault();
    document.getElementById('globalUrl').focus();
  }
});

document.getElementById('globalUrl').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('globalGo').click();
    canvas.focus();
  }
});

setInterval(updateStats, 1000);
</script>
</body>
</html>