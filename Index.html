<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Remote Browser</title>
<style>
body { background:#111; color:white; font-family:Arial; text-align:center; }
input { width:300px; padding:8px; margin-top:20px; }
button { padding:10px 18px; margin:10px; }
#status { margin-top:20px; }
</style>
</head>
<body>

<h1>Remote Browser</h1>
<input id="url" placeholder="Enter URL" />
<br>
<button onclick="launch()">Launch</button>
<div id="status">Idle</div>

<script>
function launch() {
  const popup = window.open("about:blank", "remote", "width=1400,height=800");
  popup.document.write(`
    <html><body style="margin:0;background:black;">
    <canvas id="screen" width="1366" height="768" style="width:100%;height:auto;"></canvas>
    <script>

    const cv = document.getElementById("screen");
    const ctx = cv.getContext("2d");

    const ws = new WebSocket("${location.origin.replace(/^http/,'ws')}/ws");

    let connected = false;

    ws.onopen = () => {
      ws.send(JSON.stringify({ action: "create" }));
    };

    ws.onmessage = (msg) => {
      if (typeof msg.data === "string") {
        const obj = JSON.parse(msg.data);

        if (obj.type === "created") {
          ws.send(JSON.stringify({ action: "startStream" }));
          ws.send(JSON.stringify({ action: "navigate", url: "${document.getElementById("url").value}" }));
        }
        return;
      }

      // Draw JPEG frames
      const blob = msg.data;
      const img = new Image();
      img.src = URL.createObjectURL(blob);
      img.onload = () => {
        ctx.drawImage(img, 0, 0, cv.width, cv.height);
        URL.revokeObjectURL(img.src);
      };
    };

    /* -------- Handle Mouse -------- */
    cv.addEventListener("click", e => {
      const r = cv.getBoundingClientRect();
      const x = (e.clientX - r.left) * (cv.width / r.width);
      const y = (e.clientY - r.top) * (cv.height / r.height);
      ws.send(JSON.stringify({ action: "click", x, y }));
    });

    cv.addEventListener("wheel", e => {
      ws.send(JSON.stringify({ action: "scroll", dy: e.deltaY }));
      e.preventDefault();
    }, { passive:false });

    /* -------- Handle Keyboard -------- */
    document.addEventListener("keydown", function(e) {
      const special = {
        "Backspace":"Backspace",
        "Enter":"Enter",
        "Tab":"Tab",
        "Escape":"Escape",
        "ArrowUp":"ArrowUp",
        "ArrowDown":"ArrowDown",
        "ArrowLeft":"ArrowLeft",
        "ArrowRight":"ArrowRight",
        "Delete":"Delete"
      };

      if (special[e.key]) {
        ws.send(JSON.stringify({
          action:"type",
          text:special[e.key],
          special:true
        }));
        e.preventDefault();
        return;
      }

      // Printable characters
      if (e.key.length === 1) {
        ws.send(JSON.stringify({
          action:"type",
          text:e.key
        }));
        e.preventDefault();
      }
    });

    <\/script>
    </body></html>
  `);
}

</script>

</body>
</html>
