<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Coordinated Multi-Backend Browser</title>
<style>
  * { box-sizing: border-box; }
  body { 
    font-family: 'Segoe UI', Tahoma, sans-serif; 
    margin:0; 
    background:#0a0e27; 
    color:#fff; 
    overflow:hidden;
  }
  
  .login-overlay {
    position:fixed;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:rgba(10,14,39,0.98);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:1000;
  }
  .login-overlay.hidden { display:none; }
  
  .login-box {
    max-width:400px;
    width:90%;
    padding:30px;
    background:#1a1f3a;
    border-radius:12px;
    box-shadow:0 20px 60px rgba(0,0,0,0.5);
  }
  .login-box h1 { 
    margin:0 0 10px 0; 
    font-size:26px;
    text-align:center;
    background:linear-gradient(135deg,#667eea,#764ba2);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }
  .login-box .subtitle {
    text-align:center;
    opacity:0.7;
    font-size:13px;
    margin-bottom:20px;
  }
  
  input { 
    width:100%; 
    padding:12px; 
    border-radius:8px; 
    border:1px solid #2d3748; 
    background:#0f1419;
    color:#fff;
    margin-top:8px; 
    font-size:14px;
  }
  button { 
    width:100%; 
    padding:12px; 
    border-radius:8px; 
    border:0; 
    background:#4a5de6; 
    color:#fff; 
    margin-top:12px; 
    cursor:pointer; 
    font-weight:700;
    transition: all 0.2s;
    font-size:14px;
  }
  button:hover { background:#5a6df6; transform:translateY(-1px); }
  button:disabled { background:#2d3748; cursor:not-allowed; }
  .wake-btn { background:#ffd34d !important; color:#000 !important; }
  
  .status { 
    padding:10px; 
    border-radius:8px; 
    margin-top:10px; 
    display:none;
    font-size:12px;
  }
  .status.show { display:block; }
  .status.info { background:#1e3a5f; color:#60a5fa; }
  .status.success { background:#1e3d2f; color:#4ade80; }
  .status.error { background:#3d1e1e; color:#f87171; }
  
  .main-screen {
    height:100vh;
    display:flex;
    flex-direction:column;
  }
  
  .top-bar {
    background:#1a1f3a;
    padding:10px 20px;
    display:flex;
    align-items:center;
    gap:10px;
    border-bottom:2px solid #2d3748;
    flex-shrink:0;
    z-index:100;
  }
  .top-bar h1 {
    margin:0;
    font-size:16px;
    background:linear-gradient(135deg,#667eea,#764ba2);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    white-space:nowrap;
    font-weight:900;
  }
  .url-bar {
    flex:1;
    display:flex;
    gap:8px;
  }
  .url-bar input {
    flex:1;
    margin:0;
    padding:10px;
    font-size:14px;
  }
  .url-bar button {
    width:auto;
    margin:0;
    padding:10px 20px;
    font-size:13px;
  }
  
  .stats-bar {
    display:flex;
    gap:15px;
    font-size:11px;
    color:#888;
    align-items:center;
  }
  .stat-item {
    display:flex;
    align-items:center;
    gap:5px;
  }
  .stat-value {
    color:#4ade80;
    font-weight:700;
  }
  .backend-count {
    background:#2d3748;
    padding:4px 12px;
    border-radius:12px;
    font-weight:700;
    color:#4ade80;
  }
  
  .browser-viewport {
    flex:1;
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    overflow:hidden;
  }
  .viewport-canvas {
    max-width:100%;
    max-height:100%;
    object-fit:contain;
    cursor:crosshair;
    box-shadow:0 0 40px rgba(0,0,0,0.8);
    outline:none;
  }
  
  .mode-badge-corner {
    position:absolute;
    top:15px;
    right:15px;
    background:rgba(74,222,128,0.9);
    color:#000;
    padding:8px 16px;
    border-radius:8px;
    font-size:11px;
    font-weight:700;
    pointer-events:none;
    z-index:10;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
  }
  
  .connection-status {
    position:absolute;
    top:60px;
    right:15px;
    background:rgba(26,31,58,0.95);
    padding:10px 15px;
    border-radius:8px;
    font-size:11px;
    z-index:10;
    max-width:200px;
  }
  .connection-status.hidden { display:none; }
  .conn-item {
    margin:3px 0;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .conn-dot {
    width:6px;
    height:6px;
    border-radius:50%;
    background:#f87171;
    margin-left:8px;
  }
  .conn-dot.online { background:#4ade80; }
</style>
</head>
<body>

<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h1>üöÄ Coordinated Browser</h1>
    <div class="subtitle">5 backends working together through coordinator API</div>
    
    <input id="name" placeholder="Your name" value="Alice">
    <input id="key" placeholder="Access key" type="password" value="8392017">
    
    <button class="wake-btn" id="wakeBtn">‚òï Wake Coordinator</button>
    <button id="launchBtn">üöÄ Launch Coordinated Browser</button>
    <div id="loginStatus" class="status"></div>
  </div>
</div>

<div class="main-screen" id="mainScreen" style="display:none">
  <div class="top-bar">
    <h1>COORDINATED MODE</h1>
    <div class="url-bar">
      <input id="globalUrl" placeholder="Navigate to..." value="https://example.com">
      <button id="globalGo">Go</button>
      <button id="globalBack">‚Üê</button>
      <button id="globalForward">‚Üí</button>
    </div>
    
    <div class="stats-bar">
      <div class="stat-item">
        <span>FPS:</span>
        <span class="stat-value" id="fpsValue">0</span>
      </div>
      <div class="backend-count" id="backendCount">5 Backends</div>
    </div>
  </div>
  
  <div class="browser-viewport" id="browserViewport">
    <canvas id="viewportCanvas" class="viewport-canvas" width="1366" height="768" tabindex="0"></canvas>
    <div class="mode-badge-corner">COORDINATOR API</div>
    <div class="connection-status" id="connectionStatus">
      <div style="font-weight:700;margin-bottom:5px;">Backend Status</div>
      <div id="backendStatusList"></div>
    </div>
  </div>
</div>

<script>
// COORDINATOR URL - Your 6th Render service
const COORDINATOR_URL = 'wss://browser-proxy-coordinator.onrender.com/ws';

// For validation
const COORDINATOR_HTTP = 'https://browser-proxy-coordinator.onrender.com';

const VIEWPORT_WIDTH = 1366;
const VIEWPORT_HEIGHT = 768;

let ws = null;
let userName = "";
let canvas = null;
let ctx = null;
let isConnected = false;
let backendInfo = { total: 5, ready: 0 };

// Performance tracking
let frameStats = { count: 0, lastUpdate: Date.now() };

function setStatus(msg, type) {
  const el = document.getElementById("loginStatus");
  el.innerHTML = msg;
  el.className = "status show " + (type || "");
}

function initCanvas() {
  canvas = document.getElementById('viewportCanvas');
  ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
  ctx.fillStyle = '#1a1a1a';
  ctx.fillRect(0, 0, VIEWPORT_WIDTH, VIEWPORT_HEIGHT);
  
  canvas.addEventListener('click', handleClick);
  canvas.addEventListener('wheel', handleScroll, { passive: false });
  canvas.addEventListener('keydown', handleKeydown);
  canvas.focus();
}

function handleClick(e) {
  const rect = canvas.getBoundingClientRect();
  const x = Math.round((e.clientX - rect.left) * (VIEWPORT_WIDTH / rect.width));
  const y = Math.round((e.clientY - rect.top) * (VIEWPORT_HEIGHT / rect.height));
  
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'control', action: 'click', x, y }));
  }
  
  canvas.focus();
}

function handleScroll(e) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'control', action: 'scroll', dy: e.deltaY }));
  }
  e.preventDefault();
}

function handleKeydown(e) {
  if (e.ctrlKey || e.metaKey) {
    if (e.key === 'l') {
      e.preventDefault();
      document.getElementById('globalUrl').focus();
    }
    return;
  }
  
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  
  if (e.key.length === 1) {
    ws.send(JSON.stringify({ type: 'control', action: 'type', text: e.key }));
    e.preventDefault();
  } else if (e.key === 'Enter') {
    ws.send(JSON.stringify({ type: 'control', action: 'type', text: '\n' }));
    e.preventDefault();
  } else if (e.key === 'Backspace') {
    ws.send(JSON.stringify({ type: 'control', action: 'type', text: '\b' }));
    e.preventDefault();
  } else if (e.key === 'Tab') {
    ws.send(JSON.stringify({ type: 'control', action: 'type', text: '\t' }));
    e.preventDefault();
  }
}

function updateStats() {
  const now = Date.now();
  const elapsed = (now - frameStats.lastUpdate) / 1000;
  
  if (elapsed > 1) {
    const fps = Math.round(frameStats.count / elapsed);
    document.getElementById('fpsValue').textContent = fps;
    frameStats.count = 0;
    frameStats.lastUpdate = now;
  }
}

function renderFrame(imageData) {
  if (!ctx) return;
  
  const img = new Image();
  img.onload = () => {
    requestAnimationFrame(() => {
      ctx.drawImage(img, 0, 0, VIEWPORT_WIDTH, VIEWPORT_HEIGHT);
      frameStats.count++;
    });
  };
  img.src = imageData;
}

function connectToCoordinator() {
  console.log('Connecting to coordinator...');
  
  ws = new WebSocket(COORDINATOR_URL);
  ws.binaryType = 'arraybuffer';
  
  ws.onopen = () => {
    console.log('‚úÖ Connected to coordinator');
    isConnected = true;
    
    // Create session
    ws.send(JSON.stringify({
      type: 'control',
      action: 'create',
      userName: userName
    }));
  };
  
  ws.onmessage = (e) => {
    // JSON control messages
    if (typeof e.data === 'string') {
      try {
        const msg = JSON.parse(e.data);
        
        if (msg.type === 'info' && msg.action === 'created') {
          console.log(`‚úÖ Coordinator session created with ${msg.backends} backends`);
          document.getElementById('backendCount').textContent = `${msg.backends} Backends`;
          backendInfo.total = msg.backends;
        }
        
        if (msg.type === 'info' && msg.action === 'allBackendsReady') {
          console.log(`‚úÖ All ${msg.count} backends are ready!`);
          backendInfo.ready = msg.count;
          updateBackendStatus();
        }
        
        if (msg.type === 'error') {
          console.error('Coordinator error:', msg.message);
        }
      } catch (err) {
        console.error('Failed to parse message:', err);
      }
      return;
    }
    
    // Binary frame data from coordinator
    const blob = new Blob([e.data], { type: 'image/jpeg' });
    const url = URL.createObjectURL(blob);
    renderFrame(url);
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  };
  
  ws.onerror = (err) => {
    console.error('WebSocket error:', err);
    isConnected = false;
  };
  
  ws.onclose = () => {
    console.log('Disconnected from coordinator');
    isConnected = false;
    
    // Show reconnection message
    ctx.fillStyle = '#1a1a1a';
    ctx.fillRect(0, 0, VIEWPORT_WIDTH, VIEWPORT_HEIGHT);
    ctx.fillStyle = '#fff';
    ctx.font = '24px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Disconnected - Reconnecting...', VIEWPORT_WIDTH/2, VIEWPORT_HEIGHT/2);
    
    // Attempt reconnect after 3 seconds
    setTimeout(() => {
      if (!isConnected) {
        connectToCoordinator();
      }
    }, 3000);
  };
}

function updateBackendStatus() {
  const statusList = document.getElementById('backendStatusList');
  statusList.innerHTML = '';
  
  for (let i = 0; i < backendInfo.total; i++) {
    const item = document.createElement('div');
    item.className = 'conn-item';
    const isReady = i < backendInfo.ready;
    item.innerHTML = `
      <span>Backend ${i + 1}</span>
      <div class="conn-dot ${isReady ? 'online' : ''}"></div>
    `;
    statusList.appendChild(item);
  }
}

async function validateAndLaunch() {
  const name = document.getElementById('name').value.trim();
  const key = document.getElementById('key').value.trim();
  
  if (!name || !key) {
    setStatus("‚ùå Enter credentials", "error");
    return;
  }
  
  userName = name;
  setStatus("üîç Validating...", "info");
  
  try {
    const r = await fetch(`${COORDINATOR_HTTP}/validate?name=${encodeURIComponent(name)}&key=${encodeURIComponent(key)}`);
    const j = await r.json();
    
    if (!j.valid) {
      setStatus("‚ùå Invalid credentials", "error");
      return;
    }
    
    // Hide login, show browser
    document.getElementById('loginOverlay').classList.add('hidden');
    document.getElementById('mainScreen').style.display = 'flex';
    
    initCanvas();
    connectToCoordinator();
    
  } catch (e) {
    setStatus("‚ùå Connection failed: " + e.message, "error");
  }
}

document.getElementById('wakeBtn').addEventListener('click', async () => {
  setStatus("‚òï Checking coordinator...", "info");
  
  try {
    const r = await fetch(`${COORDINATOR_HTTP}/health`, { cache: 'no-store' });
    const j = await r.json();
    
    if (j.status === 'ok') {
      setStatus(`‚úÖ Coordinator online (${j.backends} backends configured)`, "success");
    } else {
      setStatus("‚ö†Ô∏è Coordinator responded but not OK", "error");
    }
  } catch (e) {
    setStatus(`‚ùå Coordinator unreachable: ${e.message}`, "error");
  }
});

document.getElementById('launchBtn').addEventListener('click', validateAndLaunch);

document.getElementById('globalGo').addEventListener('click', () => {
  let url = document.getElementById('globalUrl').value.trim();
  if (!url) return;
  if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
  
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'control', action: 'navigate', url }));
  }
});

document.getElementById('globalBack').addEventListener('click', () => {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'control', action: 'back' }));
  }
});

document.getElementById('globalForward').addEventListener('click', () => {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'control', action: 'forward' }));
  }
});

document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
    e.preventDefault();
    document.getElementById('globalUrl').focus();
  }
});

document.getElementById('globalUrl').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('globalGo').click();
    canvas.focus();
  }
});

setInterval(updateStats, 1000);

// Show backend status on hover
document.getElementById('backendCount').addEventListener('mouseenter', () => {
  document.getElementById('connectionStatus').classList.remove('hidden');
});

setTimeout(() => {
  document.getElementById('connectionStatus').classList.add('hidden');
}, 5000);
</script>
</body>
</html>