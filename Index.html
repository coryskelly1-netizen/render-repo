<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Proxy Login</title>

    <style>
        /* Reset & prevent overflow */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        html, body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            font-family: "Segoe UI", Tahoma, sans-serif;
            background: linear-gradient(135deg, #5568e6 0%, #6b3fa0 100%);
            height: 100%;
        }

        /* Center container */
        .login-container {
            width: 100%;
            max-width: 420px;
            margin: 50px auto;
            background: #fff;
            padding: 40px 35px;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.25);
            text-align: center;
        }

        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: #4a5de6;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 28px;
        }

        .info-box {
            background: #ebf2ff;
            border-left: 4px solid #4c5ee6;
            padding: 14px;
            font-size: 13px;
            text-align: left;
            margin-bottom: 25px;
            border-radius: 8px;
        }

        .form-group {
            margin-bottom: 22px;
            text-align: left;
        }

        label {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
            display: block;
        }

        input[type="text"] {
            width: 100%;
            padding: 13px;
            border-radius: 8px;
            border: 2px solid #ddd;
            font-size: 15px;
            transition: 0.2s;
        }

        input[type="text"]:focus {
            border-color: #4c5ee6;
            outline: none;
        }

        button {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: none;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.25s;
        }

        .btn-login {
            background: #4a5de6;
            color: #fff;
            margin-top: 10px;
        }
        .btn-login:hover {
            background: #3d4ec7;
        }

        .btn-wakeup {
            background: #ffd34d;
            color: #222;
            margin-top: 14px;
        }
        .btn-wakeup:hover {
            background: #e2b63a;
        }

        .btn-launch {
            display: none;
            margin-top: 25px;
            background: #28c36b;
            color: #fff;
        }
        .btn-launch:hover {
            background: #1ea357;
        }

        .status {
            display: none;
            margin-top: 18px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
        }
        .status-valid { background: #d7f8df; color: #146c35; display: block; }
        .status-invalid { background: #ffd7da; color: #9c1d27; display: block; }
        .status-loading { background: #fff3cd; color: #856404; display: block; }
    </style>
</head>

<body>

    <div class="login-container">
        <h1>üåê Proxy Login</h1>
        <p class="subtitle">Secure Remote Browser Access</p>

        <div class="info-box">
            ‚ö†Ô∏è <strong>First time launching?</strong><br>
            The server may take 30‚Äì60 seconds to wake up.
        </div>

        <div id="loginForm">
            <div class="form-group">
                <label for="nameInput">First & Last Name</label>
                <input type="text" id="nameInput" placeholder="John Doe" />
            </div>

            <div class="form-group">
                <label for="keyInput">Access Key</label>
                <input type="text" id="keyInput" placeholder="Enter access key" />
            </div>

            <button class="btn-login" onclick="authenticate()">Login</button>
            <button class="btn-wakeup" onclick="wakeUpServer()">‚òï Wake Up Server</button>

            <div class="status" id="status"></div>
        </div>

        <button class="btn-launch" id="launchBtn" onclick="launchProxy()">üöÄ Launch Proxy Browser</button>
    </div>

    <script>
        const BACKEND_BASE = "https://render-repo-osyl.onrender.com";
        let userName = "";

        function showStatus(msg, type) {
            const s = document.getElementById("status");
            s.textContent = msg;
            s.className = "status status-" + type;
        }

        async function wakeUpServer() {
            showStatus("Waking up server...", "loading");
            try {
                const r = await fetch(BACKEND_BASE + "/health");
                const j = await r.json();
                if (j.status === "ok") {
                    showStatus("Server is awake!", "valid");
                }
            } catch {
                showStatus("Server still waking. Try again.", "loading");
            }
        }

        async function authenticate() {
            const name = document.getElementById("nameInput").value.trim();
            const key = document.getElementById("keyInput").value.trim();
            if (!name || !key) {
                showStatus("Please fill out both fields.", "invalid");
                return;
            }

            showStatus("Checking credentials...", "loading");

            try {
                const res = await fetch(
                    `${BACKEND_BASE}/validate?key=${key}&name=${encodeURIComponent(name)}`
                );
                const data = await res.json();

                if (data.valid) {
                    userName = name;
                    showStatus("Welcome, " + name + "!", "valid");
                    document.getElementById("loginForm").style.display = "none";
                    document.getElementById("launchBtn").style.display = "block";
                } else {
                    showStatus("Invalid name or key.", "invalid");
                }
            } catch (e) {
                showStatus("Connection error.", "invalid");
            }
        }

        function launchProxy() {
            const win = window.open("about:blank", "_blank");
            if (!win) {
                alert("Enable pop-ups to launch the browser.");
                return;
            }
            win.document.write(createProxyHTML());
            win.document.close();
        }

        function createProxyHTML() {
            return `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Remote Browser</title>
<style>
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; overflow:hidden; background:#121212; color:white; }

    .toolbar {
        background:#1f1f1f;
        padding:12px;
        display:flex;
        gap:10px;
        align-items:center;
        border-bottom:1px solid #333;
    }

    input {
        flex:1;
        padding:10px;
        border-radius:6px;
        border:1px solid #333;
        background:#0d0d0d;
        color:white;
    }

    button {
        background:#4a5de6;
        color:white;
        border:none;
        padding:10px 16px;
        border-radius:6px;
        cursor:pointer;
    }

    button:hover {
        background:#3d4ec7;
    }

    select {
        padding:10px;
        border-radius:6px;
        background:#0d0d0d;
        color:white;
        border:1px solid #333;
    }

    .browser {
        width:100%;
        height:calc(100vh - 64px);
        background:black;
    }

    .browser img {
        width:100%;
        height:100%;
        object-fit:contain;
        cursor:pointer;
    }
</style>
</head>
<body>

<div class="toolbar">
    <span>üë§ ${userName}</span>
    <input id="urlInput" placeholder="Enter a URL..." />
    <button onclick="navigate()">Go</button>
    <select id="qualitySelect" onchange="updateQuality()">
        <option value="low">Low</option>
        <option value="medium" selected>Medium</option>
        <option value="high">High</option>
    </select>
</div>

<div class="browser" id="browserContent">
    <div style="text-align:center;margin-top:20px;color:#888;">Initializing session...</div>
</div>

<script>
const BASE = "${BACKEND_BASE}";
let sessionId = null;
let quality = "medium";

async function createSession() {
    const r = await fetch(BASE + "/session/create", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ userName:"${userName}", userKey:"hidden" })
    });
    const j = await r.json();
    if (j.success) { sessionId = j.sessionId; updateScreenshot(); }
}

async function navigate() {
    if (!sessionId) return;
    let url = document.getElementById("urlInput").value;
    if (!url.startsWith("http")) url = "https://" + url;

    await fetch(BASE + "/session/navigate", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ sessionId, url })
    });

    updateScreenshot();
}

async function updateScreenshot() {
    if (!sessionId) return;

    const r = await fetch(BASE + "/session/screenshot/" + sessionId + "?quality=" + quality);
    const j = await r.json();
    if (j.success) displayScreenshot(j.screenshot);
}

function displayScreenshot(img) {
    document.getElementById("browserContent").innerHTML =
        '<img src="' + img + '" onclick="handleClick(event)">';
}

function updateQuality() {
    quality = document.getElementById("qualitySelect").value;
    updateScreenshot();
}

async function handleClick(e) {
    const img = e.target;
    const rect = img.getBoundingClientRect();
    const x = ((e.clientX - rect.left) * 1280) / rect.width;
    const y = ((e.clientY - rect.top) * 800) / rect.height;

    await fetch(BASE + "/session/click", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ sessionId, x, y })
    });

    setTimeout(updateScreenshot, 200);
}

createSession();
</script>

</body>
</html>`;
        }
    </script>

</body>
</html>
